<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 2 Introduction to SoilProfileCollection Objects | Algorithms for Quantitative Pedology</title>
  <meta name="description" content="Chapter 2 Introduction to SoilProfileCollection Objects | Algorithms for Quantitative Pedology" />
  <meta name="generator" content="bookdown 0.21 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 2 Introduction to SoilProfileCollection Objects | Algorithms for Quantitative Pedology" />
  <meta property="og:type" content="book" />
  
  
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 2 Introduction to SoilProfileCollection Objects | Algorithms for Quantitative Pedology" />
  
  
  

<meta name="author" content="Soil Survey Staff" />


<meta name="date" content="2021-02-10" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="index.html"/>

<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<script src="libs/accessible-code-block-0.0.1/empty-anchor.js"></script>


<style type="text/css">
code.sourceCode > span { display: inline-block; line-height: 1.25; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li>Related Books</li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Introduction</a><ul>
<li class="chapter" data-level="1.1" data-path="index.html"><a href="index.html#prologue"><i class="fa fa-check"></i><b>1.1</b> Prologue</a></li>
<li class="chapter" data-level="1.2" data-path="index.html"><a href="index.html#notes"><i class="fa fa-check"></i><b>1.2</b> Notes</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="SPC.html"><a href="SPC.html"><i class="fa fa-check"></i><b>2</b> Introduction to SoilProfileCollection Objects</a><ul>
<li class="chapter" data-level="2.1" data-path="SPC.html"><a href="SPC.html#introduction-1"><i class="fa fa-check"></i><b>2.1</b> Introduction</a></li>
<li class="chapter" data-level="2.2" data-path="SPC.html"><a href="SPC.html#object-creation"><i class="fa fa-check"></i><b>2.2</b> Object Creation</a></li>
<li class="chapter" data-level="2.3" data-path="SPC.html"><a href="SPC.html#accessing-setting-and-replacing-data"><i class="fa fa-check"></i><b>2.3</b> Accessing, Setting, and Replacing Data</a></li>
<li class="chapter" data-level="2.4" data-path="SPC.html"><a href="SPC.html#horizon-and-site-data"><i class="fa fa-check"></i><b>2.4</b> Horizon and Site Data</a></li>
<li class="chapter" data-level="2.5" data-path="SPC.html"><a href="SPC.html#diagnostic-horizons"><i class="fa fa-check"></i><b>2.5</b> Diagnostic Horizons</a></li>
<li class="chapter" data-level="2.6" data-path="SPC.html"><a href="SPC.html#root-restrictive-features"><i class="fa fa-check"></i><b>2.6</b> Root Restrictive Features</a></li>
<li class="chapter" data-level="2.7" data-path="SPC.html"><a href="SPC.html#spatial-data"><i class="fa fa-check"></i><b>2.7</b> Spatial Data</a></li>
<li class="chapter" data-level="2.8" data-path="SPC.html"><a href="SPC.html#subsetting-soilprofilecollection-objects"><i class="fa fa-check"></i><b>2.8</b> Subsetting SoilProfileCollection Objects</a></li>
<li class="chapter" data-level="2.9" data-path="SPC.html"><a href="SPC.html#concatenation-of-soilprofilecollection-objects"><i class="fa fa-check"></i><b>2.9</b> Concatenation of SoilProfileCollection Objects</a><ul>
<li class="chapter" data-level="2.9.1" data-path="SPC.html"><a href="SPC.html#splitting"><i class="fa fa-check"></i><b>2.9.1</b> Splitting</a></li>
<li class="chapter" data-level="2.9.2" data-path="SPC.html"><a href="SPC.html#duplication"><i class="fa fa-check"></i><b>2.9.2</b> Duplication</a></li>
</ul></li>
<li class="chapter" data-level="2.10" data-path="SPC.html"><a href="SPC.html#plotting-soilprofilecollection-objects"><i class="fa fa-check"></i><b>2.10</b> Plotting SoilProfileCollection Objects</a><ul>
<li class="chapter" data-level="2.10.1" data-path="SPC.html"><a href="SPC.html#making-adjustments"><i class="fa fa-check"></i><b>2.10.1</b> Making Adjustments</a></li>
<li class="chapter" data-level="2.10.2" data-path="SPC.html"><a href="SPC.html#relative-horizontal-positioning"><i class="fa fa-check"></i><b>2.10.2</b> Relative Horizontal Positioning</a></li>
<li class="chapter" data-level="2.10.3" data-path="SPC.html"><a href="SPC.html#thematic-sketches"><i class="fa fa-check"></i><b>2.10.3</b> Thematic Sketches</a></li>
<li class="chapter" data-level="2.10.4" data-path="SPC.html"><a href="SPC.html#depth-intervals"><i class="fa fa-check"></i><b>2.10.4</b> Depth Intervals</a></li>
<li class="chapter" data-level="2.10.5" data-path="SPC.html"><a href="SPC.html#svg-output-for-use-in-page-layout-tools"><i class="fa fa-check"></i><b>2.10.5</b> SVG Output for Use in Page Layout Tools</a></li>
</ul></li>
<li class="chapter" data-level="2.11" data-path="SPC.html"><a href="SPC.html#iterating-over-profiles-in-a-collection"><i class="fa fa-check"></i><b>2.11</b> Iterating Over Profiles in a Collection</a></li>
<li class="chapter" data-level="2.12" data-path="SPC.html"><a href="SPC.html#slicing-soil-profile-collections"><i class="fa fa-check"></i><b>2.12</b> Slicing Soil Profile Collections</a></li>
<li class="chapter" data-level="2.13" data-path="SPC.html"><a href="SPC.html#ragged-selection-glom"><i class="fa fa-check"></i><b>2.13</b> Ragged Selection: <code>glom</code></a><ul>
<li class="chapter" data-level="2.13.1" data-path="SPC.html"><a href="SPC.html#truncation-trunc"><i class="fa fa-check"></i><b>2.13.1</b> Truncation: <code>trunc</code></a></li>
</ul></li>
<li class="chapter" data-level="2.14" data-path="SPC.html"><a href="SPC.html#aggregating-soil-profile-collections-along-regular-slabs"><i class="fa fa-check"></i><b>2.14</b> Aggregating Soil Profile Collections Along Regular “Slabs”</a><ul>
<li class="chapter" data-level="2.14.1" data-path="SPC.html"><a href="SPC.html#change-of-support-re-alignment-of-horizon-depths-via-aggregation"><i class="fa fa-check"></i><b>2.14.1</b> Change of Support: re-alignment of horizon depths via aggregation</a></li>
</ul></li>
<li class="chapter" data-level="2.15" data-path="SPC.html"><a href="SPC.html#pair-wise-dissimilarity"><i class="fa fa-check"></i><b>2.15</b> Pair-Wise Dissimilarity</a></li>
<li class="chapter" data-level="2.16" data-path="SPC.html"><a href="SPC.html#object-metadata"><i class="fa fa-check"></i><b>2.16</b> Object Metadata</a></li>
<li class="chapter" data-level="2.17" data-path="SPC.html"><a href="SPC.html#validity-and-horizon-logic"><i class="fa fa-check"></i><b>2.17</b> Validity and Horizon Logic</a></li>
<li class="chapter" data-level="2.18" data-path="SPC.html"><a href="SPC.html#coercion"><i class="fa fa-check"></i><b>2.18</b> Coercion</a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Algorithms for Quantitative Pedology</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="SPC" class="section level1">
<h1><span class="header-section-number">Chapter 2</span> Introduction to SoilProfileCollection Objects</h1>
<div id="introduction-1" class="section level2">
<h2><span class="header-section-number">2.1</span> Introduction</h2>
<p>This is a very basic introduction to the <code>SoilProfileCollection</code> class object defined in the <code>aqp</code> package for <strong>R</strong>. The <code>SoilProfileCollection</code> class was designed to simplify the process of working with the collection of data associated with soil profiles: site-level data, horizon-level data, spatial data, diagnostic horizon data, metadata, etc. Examples listed below are meant to be copied/pasted from this document and interactively run within <strong>R</strong>. Comments (green text) briefly describe what the code in each line does. This document assumes a basic level of proficiency with <strong>R</strong> which can be gained by reviewing some of the material in <a href="http://cran.r-project.org/doc/contrib/Verzani-SimpleR.pdf">tutorials like this</a>. Further documentation on objects and functions from the <code>aqp</code> package can be accessed by typing <code>help(aqp)</code> (or more generally, <code>?function_name</code>) at the <strong>R</strong> console.</p>
</div>
<div id="object-creation" class="section level2">
<h2><span class="header-section-number">2.2</span> Object Creation</h2>
<p><code>SoilProfileCollection</code> objects are typically created by “promoting” <code>data.frame</code> objects (rectangular tables of data) that contain at least three essential columns:</p>
<ol style="list-style-type: decimal">
<li>an ID column uniquely identifying groups of horizons (e.g. pedons)</li>
<li>horizon top boundaries</li>
<li>horizon bottom boundaries</li>
</ol>
<p>The <code>data.frame</code> should be pre-sorted according to the profile ID and horizon top boundary. Formula notation is used to define the columns used to promote a <code>data.frame</code> object:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r codeBlock"><code class="sourceCode r"><span id="cb1-1"><a href="SPC.html#cb1-1"></a>idcolumn <span class="op">~</span><span class="st"> </span>hz_top_column <span class="op">+</span><span class="st"> </span>hz_bottom_column</span></code></pre></div>
<p>In this tutorial we will use some sample data included with the <code>aqp</code> package, based on characterization data from 10 soils sampled on serpentinitic parent material as described in <a href="https://www.soils.org/publications/sssaj/articles/73/6/2087">McGahan et al, 2009</a>.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r codeBlock"><code class="sourceCode r"><span id="cb2-1"><a href="SPC.html#cb2-1"></a><span class="co"># load required packages, you may have to install these if missing:</span></span>
<span id="cb2-2"><a href="SPC.html#cb2-2"></a><span class="co"># install.packages(&#39;aqp&#39;, dep = TRUE)</span></span>
<span id="cb2-3"><a href="SPC.html#cb2-3"></a><span class="co"># remotes::install_github(&quot;ncss-tech/aqp&quot;, dependencies=FALSE, upgrade=FALSE, build=FALSE)</span></span>
<span id="cb2-4"><a href="SPC.html#cb2-4"></a><span class="kw">library</span>(aqp)</span>
<span id="cb2-5"><a href="SPC.html#cb2-5"></a><span class="kw">library</span>(Hmisc)</span>
<span id="cb2-6"><a href="SPC.html#cb2-6"></a><span class="kw">library</span>(lattice)</span>
<span id="cb2-7"><a href="SPC.html#cb2-7"></a><span class="kw">library</span>(MASS)</span>
<span id="cb2-8"><a href="SPC.html#cb2-8"></a></span>
<span id="cb2-9"><a href="SPC.html#cb2-9"></a><span class="co"># load sample data set, a data.frame object with horizon-level data from 10 profiles</span></span>
<span id="cb2-10"><a href="SPC.html#cb2-10"></a><span class="kw">data</span>(sp4)</span>
<span id="cb2-11"><a href="SPC.html#cb2-11"></a><span class="kw">str</span>(sp4)</span></code></pre></div>
<pre class="outputBlock"><code>## &#39;data.frame&#39;:    30 obs. of  13 variables:
##  $ id         : chr  &quot;colusa&quot; &quot;colusa&quot; &quot;colusa&quot; &quot;colusa&quot; ...
##  $ name       : chr  &quot;A&quot; &quot;ABt&quot; &quot;Bt1&quot; &quot;Bt2&quot; ...
##  $ top        : int  0 3 8 30 0 9 0 4 13 0 ...
##  $ bottom     : int  3 8 30 42 9 34 4 13 40 6 ...
##  $ K          : num  0.3 0.2 0.1 0.1 0.2 0.3 0.2 0.6 0.8 0.4 ...
##  $ Mg         : num  25.7 23.7 23.2 44.3 21.9 18.9 12.1 12.1 17.7 16.4 ...
##  $ Ca         : num  9 5.6 1.9 0.3 4.4 4.5 1.4 7 4.4 24.1 ...
##  $ CEC_7      : num  23 21.4 23.7 43 18.8 27.5 23.7 18 20 31.1 ...
##  $ ex_Ca_to_Mg: num  0.35 0.23 0.08 0.01 0.2 0.2 0.58 0.51 0.25 1.47 ...
##  $ sand       : int  46 42 40 27 54 49 43 36 27 43 ...
##  $ silt       : int  33 31 28 18 20 18 55 49 45 42 ...
##  $ clay       : int  21 27 32 55 25 34 3 15 27 15 ...
##  $ CF         : num  0.12 0.27 0.27 0.16 0.55 0.84 0.5 0.75 0.67 0.02 ...</code></pre>
<div class="sourceCode" id="cb4"><pre class="sourceCode r codeBlock"><code class="sourceCode r"><span id="cb4-1"><a href="SPC.html#cb4-1"></a><span class="co"># optionally read about it...</span></span>
<span id="cb4-2"><a href="SPC.html#cb4-2"></a><span class="co"># ?sp4</span></span>
<span id="cb4-3"><a href="SPC.html#cb4-3"></a></span>
<span id="cb4-4"><a href="SPC.html#cb4-4"></a><span class="co"># upgrade to SoilProfileCollection</span></span>
<span id="cb4-5"><a href="SPC.html#cb4-5"></a><span class="co"># &#39;id&#39; is the name of the column containing the profile ID</span></span>
<span id="cb4-6"><a href="SPC.html#cb4-6"></a><span class="co"># &#39;top&#39; is the name of the column containing horizon upper boundaries</span></span>
<span id="cb4-7"><a href="SPC.html#cb4-7"></a><span class="co"># &#39;bottom&#39; is the name of the column containing horizon lower boundaries</span></span>
<span id="cb4-8"><a href="SPC.html#cb4-8"></a><span class="kw">depths</span>(sp4) &lt;-<span class="st"> </span>id <span class="op">~</span><span class="st"> </span>top <span class="op">+</span><span class="st"> </span>bottom</span>
<span id="cb4-9"><a href="SPC.html#cb4-9"></a></span>
<span id="cb4-10"><a href="SPC.html#cb4-10"></a><span class="co"># register horizon designation column</span></span>
<span id="cb4-11"><a href="SPC.html#cb4-11"></a><span class="kw">hzdesgnname</span>(sp4) &lt;-<span class="st"> &#39;name&#39;</span></span>
<span id="cb4-12"><a href="SPC.html#cb4-12"></a></span>
<span id="cb4-13"><a href="SPC.html#cb4-13"></a><span class="co"># check it out:</span></span>
<span id="cb4-14"><a href="SPC.html#cb4-14"></a><span class="kw">class</span>(sp4)</span></code></pre></div>
<pre class="outputBlock"><code>## [1] &quot;SoilProfileCollection&quot;
## attr(,&quot;package&quot;)
## [1] &quot;aqp&quot;</code></pre>
<div class="sourceCode" id="cb6"><pre class="sourceCode r codeBlock"><code class="sourceCode r"><span id="cb6-1"><a href="SPC.html#cb6-1"></a><span class="kw">print</span>(sp4)</span></code></pre></div>
<pre class="outputBlock"><code>## SoilProfileCollection with 10 profiles and 30 horizons
## profile ID: id  |  horizon ID: hzID 
## Depth range: 16 - 49 cm
## 
## ----- Horizons (6 / 30 rows  |  10 / 14 columns) -----
##  name     id hzID top bottom   K   Mg  Ca CEC_7 ex_Ca_to_Mg
##     A colusa    1   0      3 0.3 25.7 9.0  23.0        0.35
##   ABt colusa    2   3      8 0.2 23.7 5.6  21.4        0.23
##   Bt1 colusa    3   8     30 0.1 23.2 1.9  23.7        0.08
##   Bt2 colusa    4  30     42 0.1 44.3 0.3  43.0        0.01
##     A  glenn    5   0      9 0.2 21.9 4.4  18.8        0.20
##    Bt  glenn    6   9     34 0.3 18.9 4.5  27.5        0.20
## [... more horizons ...]
## 
## ----- Sites (6 / 10 rows  |  1 / 1 columns) -----
##         id
##     colusa
##      glenn
##      kings
##   mariposa
##  mendocino
##       napa
## [... more sites ...]
## 
## Spatial Data: [EMPTY]</code></pre>
</div>
<div id="accessing-setting-and-replacing-data" class="section level2">
<h2><span class="header-section-number">2.3</span> Accessing, Setting, and Replacing Data</h2>
<p>“Accessor” functions are used to extract specific components from within <code>SoilProfileCollection</code> objects.</p>
<ul>
<li><p>Methods that return a column name. These are useful for extracting depths, horizon designations, IDs, etc. before taking an SPC apart for a specific task.</p>
<ul>
<li><code>idname(sp4)</code>: extract profile ID name (column name used to init SPC)</li>
<li><code>hzidname(sp4)</code>: horizon ID name (typically automatically built at init time)</li>
<li><code>horizonDepths(sp4)</code>: horizon top / bottom depth names (used to init SPC)</li>
<li><code>hzdesgnname(sp4)</code>: horizon designation name (if set)</li>
</ul></li>
<li><p>Methods that return a vector of values.</p>
<ul>
<li><code>profile_id(sp4)</code>: profile IDs, in order</li>
<li><code>hzID(sp4)</code>: horizon IDs, in order</li>
<li><code>hzDesgn(sp4)</code>: horizon designations, in order</li>
</ul></li>
<li><p>Methods that return site/horizon attribute column names.</p>
<ul>
<li><code>names(sp4)</code>: site + horizon names concatenated into a single vector</li>
<li><code>horizonNames(sp4)</code>: horizon names</li>
<li><code>siteNames(sp4)</code>: site names</li>
</ul></li>
<li><p>Profile and horizon totals.</p>
<ul>
<li><code>length(sp4)</code>: number of profiles in collection</li>
<li><code>nrow(sp4)</code>: number of horizons in collection</li>
</ul></li>
<li><p>Other methods.</p>
<ul>
<li><code>depth_units(sp4)</code>: defaults to ‘cm’ at SPC creation</li>
<li><code>metadata(sp4)</code></li>
</ul></li>
</ul>
</div>
<div id="horizon-and-site-data" class="section level2">
<h2><span class="header-section-number">2.4</span> Horizon and Site Data</h2>
<p>Typically, horizon and site data are the most important components of <code>SoilProfileCollection</code> objects. Both are internally stored as <code>data.frame</code>, <code>data.table</code>, or <code>tbl_df</code> objects; with one or more rows (per profile ID) in the horizon table and one row (per profile ID) in the site table. Columns from either table can be accessed with the <code>$</code> style notation of <code>data.frames</code>. New data can be assigned to either table in the same manner, as long as the length of the new data is either:</p>
<ol style="list-style-type: decimal">
<li>same length as the number of profiles in the collection (target is the site table)</li>
<li>same length as the number of horizons in the collection (target is the horizon table)</li>
</ol>
<div class="sourceCode" id="cb8"><pre class="sourceCode r codeBlock"><code class="sourceCode r"><span id="cb8-1"><a href="SPC.html#cb8-1"></a><span class="co"># assignment of new data to existing or new attributes</span></span>
<span id="cb8-2"><a href="SPC.html#cb8-2"></a>sp4<span class="op">$</span>elevation &lt;-<span class="st"> </span><span class="kw">rnorm</span>(<span class="dt">n=</span><span class="kw">length</span>(sp4), <span class="dt">mean=</span><span class="dv">1000</span>, <span class="dt">sd=</span><span class="dv">150</span>) <span class="co"># site-level, based on length of assigned data</span></span>
<span id="cb8-3"><a href="SPC.html#cb8-3"></a>sp4<span class="op">$</span>thickness &lt;-<span class="st"> </span>sp4<span class="op">$</span>bottom <span class="op">-</span><span class="st"> </span>sp4<span class="op">$</span>top <span class="co"># horizon-level</span></span>
<span id="cb8-4"><a href="SPC.html#cb8-4"></a></span>
<span id="cb8-5"><a href="SPC.html#cb8-5"></a><span class="co"># extraction of specific attributes by name</span></span>
<span id="cb8-6"><a href="SPC.html#cb8-6"></a>sp4<span class="op">$</span>clay <span class="co"># vector of clay content (horizon data)</span></span></code></pre></div>
<pre class="outputBlock"><code>##  [1] 21 27 32 55 25 34  3 15 27 32 25 31 33 13 21 23 15 17 12 19 14 14 22 25 40 51 67 24 25 32</code></pre>
<div class="sourceCode" id="cb10"><pre class="sourceCode r codeBlock"><code class="sourceCode r"><span id="cb10-1"><a href="SPC.html#cb10-1"></a>sp4<span class="op">$</span>elevation <span class="co"># vector of simulated elevation (site data)</span></span></code></pre></div>
<pre class="outputBlock"><code>##  [1] 1057.9340 1093.8384 1070.2459  945.5708  799.5650  891.9214 1018.0275  941.4441  804.8106
## [10]  967.5747</code></pre>
<div class="sourceCode" id="cb12"><pre class="sourceCode r codeBlock"><code class="sourceCode r"><span id="cb12-1"><a href="SPC.html#cb12-1"></a><span class="co"># assign a single single value into horizon-level attributes</span></span>
<span id="cb12-2"><a href="SPC.html#cb12-2"></a>sp4<span class="op">$</span>constant &lt;-<span class="st"> </span><span class="kw">rep</span>(<span class="dv">1</span>, <span class="dt">times=</span><span class="kw">nrow</span>(sp4))</span>
<span id="cb12-3"><a href="SPC.html#cb12-3"></a></span>
<span id="cb12-4"><a href="SPC.html#cb12-4"></a><span class="co"># promote horizon-level data to site-level data (when it makes sense to do so)</span></span>
<span id="cb12-5"><a href="SPC.html#cb12-5"></a><span class="co"># note that this _moves_ the named column from horizon to site</span></span>
<span id="cb12-6"><a href="SPC.html#cb12-6"></a><span class="kw">site</span>(sp4) &lt;-<span class="st"> </span><span class="er">~</span><span class="st"> </span>constant </span></code></pre></div>
<p>Horizon and site data can also be modified via extraction to <code>data.frame</code> followed by replacement (horizon data) or join (site data). Note that while this approach gives the most flexibility, it is also the most dangerous– replacement of horizon data with new data that don’t exactly conform to the original sorting may corrupt your <code>SoilProfileCollection</code>.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r codeBlock"><code class="sourceCode r"><span id="cb13-1"><a href="SPC.html#cb13-1"></a><span class="co"># extract horizon data to data.frame</span></span>
<span id="cb13-2"><a href="SPC.html#cb13-2"></a>h &lt;-<span class="st"> </span><span class="kw">horizons</span>(sp4)</span>
<span id="cb13-3"><a href="SPC.html#cb13-3"></a></span>
<span id="cb13-4"><a href="SPC.html#cb13-4"></a><span class="co"># add a new column and save back to original object</span></span>
<span id="cb13-5"><a href="SPC.html#cb13-5"></a>h<span class="op">$</span>random.numbers &lt;-<span class="st"> </span><span class="kw">rnorm</span>(<span class="dt">n=</span><span class="kw">nrow</span>(h), <span class="dt">mean=</span><span class="dv">0</span>, <span class="dt">sd=</span><span class="dv">1</span>)</span>
<span id="cb13-6"><a href="SPC.html#cb13-6"></a></span>
<span id="cb13-7"><a href="SPC.html#cb13-7"></a><span class="co"># _replace_ original horizon data with modified version</span></span>
<span id="cb13-8"><a href="SPC.html#cb13-8"></a><span class="co"># ! row-order should not be altered !</span></span>
<span id="cb13-9"><a href="SPC.html#cb13-9"></a><span class="kw">horizons</span>(sp4) &lt;-<span class="st"> </span>h</span>
<span id="cb13-10"><a href="SPC.html#cb13-10"></a></span>
<span id="cb13-11"><a href="SPC.html#cb13-11"></a><span class="co"># extract site data to data.frame</span></span>
<span id="cb13-12"><a href="SPC.html#cb13-12"></a>s &lt;-<span class="st"> </span><span class="kw">site</span>(sp4)</span>
<span id="cb13-13"><a href="SPC.html#cb13-13"></a></span>
<span id="cb13-14"><a href="SPC.html#cb13-14"></a><span class="co"># add a fake group to the site data</span></span>
<span id="cb13-15"><a href="SPC.html#cb13-15"></a>s<span class="op">$</span>group &lt;-<span class="st"> </span><span class="kw">factor</span>(<span class="kw">rep</span>(<span class="kw">c</span>(<span class="st">&#39;A&#39;</span>, <span class="st">&#39;B&#39;</span>), <span class="dt">length.out=</span><span class="kw">nrow</span>(s)))</span>
<span id="cb13-16"><a href="SPC.html#cb13-16"></a></span>
<span id="cb13-17"><a href="SPC.html#cb13-17"></a><span class="co"># join new site data with previous data: old data are _not_ replaced</span></span>
<span id="cb13-18"><a href="SPC.html#cb13-18"></a><span class="kw">site</span>(sp4) &lt;-<span class="st"> </span>s</span>
<span id="cb13-19"><a href="SPC.html#cb13-19"></a></span>
<span id="cb13-20"><a href="SPC.html#cb13-20"></a><span class="co"># check:</span></span>
<span id="cb13-21"><a href="SPC.html#cb13-21"></a>sp4</span></code></pre></div>
<pre class="outputBlock"><code>## SoilProfileCollection with 10 profiles and 30 horizons
## profile ID: id  |  horizon ID: hzID 
## Depth range: 16 - 49 cm
## 
## ----- Horizons (6 / 30 rows  |  10 / 16 columns) -----
##  name     id hzID top bottom   K   Mg  Ca CEC_7 ex_Ca_to_Mg
##     A colusa    1   0      3 0.3 25.7 9.0  23.0        0.35
##   ABt colusa    2   3      8 0.2 23.7 5.6  21.4        0.23
##   Bt1 colusa    3   8     30 0.1 23.2 1.9  23.7        0.08
##   Bt2 colusa    4  30     42 0.1 44.3 0.3  43.0        0.01
##     A  glenn    5   0      9 0.2 21.9 4.4  18.8        0.20
##    Bt  glenn    6   9     34 0.3 18.9 4.5  27.5        0.20
## [... more horizons ...]
## 
## ----- Sites (6 / 10 rows  |  4 / 4 columns) -----
##         id elevation constant group
##     colusa 1057.9340        1     A
##      glenn 1093.8384        1     B
##      kings 1070.2459        1     A
##   mariposa  945.5708        1     B
##  mendocino  799.5650        1     A
##       napa  891.9214        1     B
## [... more sites ...]
## 
## Spatial Data: [EMPTY]</code></pre>
</div>
<div id="diagnostic-horizons" class="section level2">
<h2><span class="header-section-number">2.5</span> Diagnostic Horizons</h2>
<p>Diagnostic horizons typically span several genetic horizons and may or may not be present in all profiles. To accommodate the wide range of possibilities, diagnostic horizon data are stored as a <code>data.frame</code> in “long format”: each row corresponds to a diagnostic horizon, identified with a column matching the ID column used to initialize the <code>SoilProfileCollection</code> object.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r codeBlock"><code class="sourceCode r"><span id="cb15-1"><a href="SPC.html#cb15-1"></a><span class="co"># manually create some diagnostic horizon data</span></span>
<span id="cb15-2"><a href="SPC.html#cb15-2"></a><span class="co"># there is no restrictions on data format, as long as each row has an ID that exists within the collection</span></span>
<span id="cb15-3"><a href="SPC.html#cb15-3"></a><span class="co"># be sure to use the ID column name that was used to initialize the SoilProfileCollection object</span></span>
<span id="cb15-4"><a href="SPC.html#cb15-4"></a><span class="co"># check via: idname(sp4)</span></span>
<span id="cb15-5"><a href="SPC.html#cb15-5"></a>dh &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">id=</span><span class="st">&#39;colusa&#39;</span>, <span class="dt">kind=</span><span class="st">&#39;argillic&#39;</span>, <span class="dt">top=</span><span class="dv">8</span>, <span class="dt">bottom=</span><span class="dv">42</span>, <span class="dt">stringsAsFactors=</span><span class="ot">FALSE</span>)</span>
<span id="cb15-6"><a href="SPC.html#cb15-6"></a></span>
<span id="cb15-7"><a href="SPC.html#cb15-7"></a><span class="co"># overwrite any existing diagnostic horizon data</span></span>
<span id="cb15-8"><a href="SPC.html#cb15-8"></a><span class="kw">diagnostic_hz</span>(sp4) &lt;-<span class="st"> </span>dh</span>
<span id="cb15-9"><a href="SPC.html#cb15-9"></a></span>
<span id="cb15-10"><a href="SPC.html#cb15-10"></a><span class="co"># append to diagnostic horizon data</span></span>
<span id="cb15-11"><a href="SPC.html#cb15-11"></a>dh &lt;-<span class="st"> </span><span class="kw">diagnostic_hz</span>(sp4)</span>
<span id="cb15-12"><a href="SPC.html#cb15-12"></a>dh.new &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">id=</span><span class="st">&#39;napa&#39;</span>, <span class="dt">kind=</span><span class="st">&#39;argillic&#39;</span>, <span class="dt">top=</span><span class="dv">6</span>, <span class="dt">bottom=</span><span class="dv">20</span>, <span class="dt">stringsAsFactors=</span><span class="ot">FALSE</span>)</span>
<span id="cb15-13"><a href="SPC.html#cb15-13"></a></span>
<span id="cb15-14"><a href="SPC.html#cb15-14"></a><span class="co"># overwrite existing diagnostic horizon data with appended data</span></span>
<span id="cb15-15"><a href="SPC.html#cb15-15"></a><span class="kw">diagnostic_hz</span>(sp4) &lt;-<span class="st"> </span><span class="kw">rbind</span>(dh, dh.new)</span></code></pre></div>
</div>
<div id="root-restrictive-features" class="section level2">
<h2><span class="header-section-number">2.6</span> Root Restrictive Features</h2>
<p>Features that restrict root entry (fine or very fine roots) are commonly used to estimate <em>functional</em> soil depth. Restrictive features include duripans, fragipans, paralithic matrials, lithic contact, or an abrupt change in chemical property. Not all soils have restrictive features, therefore these data are stored as a <code>data.frame</code> in “long format”. Each row corresponds to a restrictive feature, associated depths, and identified by <code>profile_id()</code>. There may be more than one restrictive feature per soil profile.</p>
<p>The example data <code>sp4</code> does not contain restrictive features, so we will simulate some at the bottom of each profile + 20cm.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r codeBlock"><code class="sourceCode r"><span id="cb16-1"><a href="SPC.html#cb16-1"></a><span class="co"># get the depth of each profile</span></span>
<span id="cb16-2"><a href="SPC.html#cb16-2"></a>rf.top &lt;-<span class="st"> </span><span class="kw">profileApply</span>(sp4, max)</span>
<span id="cb16-3"><a href="SPC.html#cb16-3"></a>rf.bottom &lt;-<span class="st"> </span>rf.top <span class="op">+</span><span class="st"> </span><span class="dv">20</span></span>
<span id="cb16-4"><a href="SPC.html#cb16-4"></a></span>
<span id="cb16-5"><a href="SPC.html#cb16-5"></a><span class="co"># the profile IDs can be extracted from the names attribute</span></span>
<span id="cb16-6"><a href="SPC.html#cb16-6"></a>pIDs &lt;-<span class="st"> </span><span class="kw">names</span>(rf.top)</span>
<span id="cb16-7"><a href="SPC.html#cb16-7"></a></span>
<span id="cb16-8"><a href="SPC.html#cb16-8"></a><span class="co"># carefully make data.frame</span></span>
<span id="cb16-9"><a href="SPC.html#cb16-9"></a><span class="co"># note: profile IDs must be stored in a column named for idname(sp4) -&gt; &#39;id&#39;</span></span>
<span id="cb16-10"><a href="SPC.html#cb16-10"></a>rf &lt;-<span class="st"> </span><span class="kw">data.frame</span>(</span>
<span id="cb16-11"><a href="SPC.html#cb16-11"></a>  <span class="dt">id =</span> pIDs, </span>
<span id="cb16-12"><a href="SPC.html#cb16-12"></a>  <span class="dt">top =</span> rf.top, </span>
<span id="cb16-13"><a href="SPC.html#cb16-13"></a>  <span class="dt">bottom =</span> rf.bottom, </span>
<span id="cb16-14"><a href="SPC.html#cb16-14"></a>  <span class="dt">kind=</span><span class="st">&#39;fake&#39;</span>, </span>
<span id="cb16-15"><a href="SPC.html#cb16-15"></a>  <span class="dt">stringsAsFactors=</span><span class="ot">FALSE</span></span>
<span id="cb16-16"><a href="SPC.html#cb16-16"></a>)</span>
<span id="cb16-17"><a href="SPC.html#cb16-17"></a></span>
<span id="cb16-18"><a href="SPC.html#cb16-18"></a><span class="co"># overwrite any existing diagnostic horizon data</span></span>
<span id="cb16-19"><a href="SPC.html#cb16-19"></a><span class="kw">restrictions</span>(sp4) &lt;-<span class="st"> </span>rf</span>
<span id="cb16-20"><a href="SPC.html#cb16-20"></a></span>
<span id="cb16-21"><a href="SPC.html#cb16-21"></a><span class="co"># check</span></span>
<span id="cb16-22"><a href="SPC.html#cb16-22"></a><span class="kw">restrictions</span>(sp4)</span></code></pre></div>
<pre class="outputBlock"><code>##                id top bottom kind
## 1          colusa  42     62 fake
## 2           glenn  34     54 fake
## 3           kings  40     60 fake
## 4        mariposa  49     69 fake
## 5       mendocino  30     50 fake
## 6            napa  20     40 fake
## 7      san benito  20     40 fake
## 8          shasta  40     60 fake
## 9  shasta-trinity  40     60 fake
## 10         tehama  16     36 fake</code></pre>
</div>
<div id="spatial-data" class="section level2">
<h2><span class="header-section-number">2.7</span> Spatial Data</h2>
<p>Spatial data can be explicitly stored within a <code>SoilProfileCollection</code> object and accessed with methods imported from the <a href="http://cran.at.r-project.org/web/packages/sp/index.html">sp</a> package. The use of <code>sp</code> classes (in this case <code>SpatialPoints</code> and <code>SpatialPointsDataFrame</code> objects) simplifies operations such as <a href="http://cran.at.r-project.org/web/packages/sp/vignettes/intro_sp.pdf">plotting spatial data, coordinate system transformations, and spatial queries</a>.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r codeBlock"><code class="sourceCode r"><span id="cb18-1"><a href="SPC.html#cb18-1"></a><span class="co"># generate some fake coordinates as site level attributes</span></span>
<span id="cb18-2"><a href="SPC.html#cb18-2"></a>sp4<span class="op">$</span>x &lt;-<span class="st"> </span><span class="kw">rnorm</span>(<span class="dt">n =</span> <span class="kw">length</span>(sp4), <span class="dt">mean =</span> <span class="dv">354000</span>, <span class="dt">sd =</span> <span class="dv">100</span>)</span>
<span id="cb18-3"><a href="SPC.html#cb18-3"></a>sp4<span class="op">$</span>y &lt;-<span class="st"> </span><span class="kw">rnorm</span>(<span class="dt">n =</span> <span class="kw">length</span>(sp4), <span class="dt">mean =</span> <span class="dv">4109533</span>, <span class="dt">sd =</span> <span class="dv">100</span>)</span>
<span id="cb18-4"><a href="SPC.html#cb18-4"></a></span>
<span id="cb18-5"><a href="SPC.html#cb18-5"></a><span class="co"># initialize spatial coordinates</span></span>
<span id="cb18-6"><a href="SPC.html#cb18-6"></a><span class="kw">coordinates</span>(sp4) &lt;-<span class="st"> </span><span class="er">~</span><span class="st"> </span>x <span class="op">+</span><span class="st"> </span>y</span>
<span id="cb18-7"><a href="SPC.html#cb18-7"></a></span>
<span id="cb18-8"><a href="SPC.html#cb18-8"></a><span class="co"># extract coordinates as matrix</span></span>
<span id="cb18-9"><a href="SPC.html#cb18-9"></a><span class="kw">coordinates</span>(sp4)</span></code></pre></div>
<pre class="outputBlock"><code>##           x       y
## 1  354153.6 4109347
## 2  353857.6 4109691
## 3  353989.1 4109398
## 4  354060.3 4109402
## 5  353916.7 4109543
## 6  354028.7 4109642
## 7  354025.1 4109560
## 8  353893.8 4109534
## 9  354013.5 4109473
## 10 354118.1 4109563</code></pre>
<div class="sourceCode" id="cb20"><pre class="sourceCode r codeBlock"><code class="sourceCode r"><span id="cb20-1"><a href="SPC.html#cb20-1"></a><span class="co"># get/set spatial reference system using PROJ4 syntax</span></span>
<span id="cb20-2"><a href="SPC.html#cb20-2"></a><span class="kw">proj4string</span>(sp4) &lt;-<span class="st"> &#39;+proj=utm +zone=11 +datum=NAD83&#39;</span></span>
<span id="cb20-3"><a href="SPC.html#cb20-3"></a><span class="kw">proj4string</span>(sp4)</span></code></pre></div>
<pre class="outputBlock"><code>## [1] &quot;+proj=utm +zone=11 +datum=NAD83 +units=m +no_defs&quot;</code></pre>
<div class="sourceCode" id="cb22"><pre class="sourceCode r codeBlock"><code class="sourceCode r"><span id="cb22-1"><a href="SPC.html#cb22-1"></a><span class="co"># extract spatial data + site level attribtutes</span></span>
<span id="cb22-2"><a href="SPC.html#cb22-2"></a><span class="co"># see ?SpatialPointsDataFrame for details</span></span>
<span id="cb22-3"><a href="SPC.html#cb22-3"></a>sp4.sp &lt;-<span class="st"> </span><span class="kw">as</span>(sp4, <span class="st">&#39;SpatialPointsDataFrame&#39;</span>)</span>
<span id="cb22-4"><a href="SPC.html#cb22-4"></a></span>
<span id="cb22-5"><a href="SPC.html#cb22-5"></a><span class="co"># plot the fake coordinates</span></span>
<span id="cb22-6"><a href="SPC.html#cb22-6"></a><span class="kw">plot</span>(sp4.sp)</span>
<span id="cb22-7"><a href="SPC.html#cb22-7"></a><span class="kw">box</span>()</span></code></pre></div>
<p><img src="aqpbook_files/figure-html/spatial-1.png" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r codeBlock"><code class="sourceCode r"><span id="cb23-1"><a href="SPC.html#cb23-1"></a><span class="co"># in the presence of spatial data, subsetting can either result in </span></span>
<span id="cb23-2"><a href="SPC.html#cb23-2"></a><span class="co"># 1. a new SoilProfileCollection (&gt; 1 horizon / profile)</span></span>
<span id="cb23-3"><a href="SPC.html#cb23-3"></a><span class="co"># 2. a new SpatialPointsDataFrame (1 horizon / profile)</span></span>
<span id="cb23-4"><a href="SPC.html#cb23-4"></a><span class="kw">class</span>(sp4[<span class="dv">1</span>, ]) <span class="co"># profile 1 from the collection</span></span></code></pre></div>
<pre class="outputBlock"><code>## [1] &quot;SoilProfileCollection&quot;
## attr(,&quot;package&quot;)
## [1] &quot;aqp&quot;</code></pre>
<div class="sourceCode" id="cb25"><pre class="sourceCode r codeBlock"><code class="sourceCode r"><span id="cb25-1"><a href="SPC.html#cb25-1"></a><span class="kw">class</span>(sp4[, <span class="dv">1</span>]) <span class="co"># horizon 1 from each profile</span></span></code></pre></div>
<pre class="outputBlock"><code>## [1] &quot;SoilProfileCollection&quot;
## attr(,&quot;package&quot;)
## [1] &quot;aqp&quot;</code></pre>
</div>
<div id="subsetting-soilprofilecollection-objects" class="section level2">
<h2><span class="header-section-number">2.8</span> Subsetting SoilProfileCollection Objects</h2>
<p><code>SoilProfileCollection</code> objects can be subset using the familiar <code>[</code>-style notation used by matrix and <code>data.frame</code> objects, such that: <code>spc[i, j]</code> will return profiles identified by the integer vector <code>i</code>, and horizons identified by the integer vector <code>j</code>. Omitting either index will result in all profiles (<code>i</code> omitted) or all horizons (<code>j</code> omitted). Typically, site-level attributes will be used as the subsetting criteria. Functions that return an index to matches (such as <code>grep()</code> or <code>which()</code>) provide the link between attributes and an index to matching profiles. Some examples:</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r codeBlock"><code class="sourceCode r"><span id="cb27-1"><a href="SPC.html#cb27-1"></a><span class="co"># explicit string matching</span></span>
<span id="cb27-2"><a href="SPC.html#cb27-2"></a>idx &lt;-<span class="st"> </span><span class="kw">which</span>(sp4<span class="op">$</span>group <span class="op">==</span><span class="st"> &#39;A&#39;</span>)</span>
<span id="cb27-3"><a href="SPC.html#cb27-3"></a></span>
<span id="cb27-4"><a href="SPC.html#cb27-4"></a><span class="co"># numerical expressions</span></span>
<span id="cb27-5"><a href="SPC.html#cb27-5"></a>idx &lt;-<span class="st"> </span><span class="kw">which</span>(sp4<span class="op">$</span>elevation <span class="op">&lt;</span><span class="st"> </span><span class="dv">1000</span>)</span>
<span id="cb27-6"><a href="SPC.html#cb27-6"></a></span>
<span id="cb27-7"><a href="SPC.html#cb27-7"></a><span class="co"># regular expression, matches any profile ID containing &#39;shasta&#39;</span></span>
<span id="cb27-8"><a href="SPC.html#cb27-8"></a>idx &lt;-<span class="st"> </span><span class="kw">grep</span>(<span class="st">&#39;shasta&#39;</span>, <span class="kw">profile_id</span>(sp4), <span class="dt">ignore.case=</span><span class="ot">TRUE</span>)</span>
<span id="cb27-9"><a href="SPC.html#cb27-9"></a></span>
<span id="cb27-10"><a href="SPC.html#cb27-10"></a><span class="co"># perform subset based on index</span></span>
<span id="cb27-11"><a href="SPC.html#cb27-11"></a>sp4[idx, ]</span></code></pre></div>
<p>Simpler subsetting with <code>subset</code>:</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode r codeBlock"><code class="sourceCode r"><span id="cb28-1"><a href="SPC.html#cb28-1"></a><span class="kw">subset</span>(sp4, group <span class="op">==</span><span class="st"> &#39;A&#39;</span>)</span>
<span id="cb28-2"><a href="SPC.html#cb28-2"></a><span class="kw">subset</span>(sp4, elevation <span class="op">&lt;</span><span class="st"> </span><span class="dv">1000</span>)</span>
<span id="cb28-3"><a href="SPC.html#cb28-3"></a><span class="kw">subset</span>(sp4, <span class="kw">grepl</span>(<span class="st">&#39;shasta&#39;</span>, id, <span class="dt">ignore.case =</span> <span class="ot">TRUE</span>))</span></code></pre></div>
</div>
<div id="concatenation-of-soilprofilecollection-objects" class="section level2">
<h2><span class="header-section-number">2.9</span> Concatenation of SoilProfileCollection Objects</h2>
<p><code>SoilProfileCollection</code> objects are combined by passing a list of objects to the <code>combine</code> function. Ideally all objects share the same internal structure, profile ID, horizon ID, depth units, and other parameters of a <code>SoilProfileCollection</code>. Manually subset the example data into 3 pieces, compile into a list, and then <code>combine</code> back together.</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode r codeBlock"><code class="sourceCode r"><span id="cb29-1"><a href="SPC.html#cb29-1"></a><span class="co"># subset data into chunks</span></span>
<span id="cb29-2"><a href="SPC.html#cb29-2"></a>s1 &lt;-<span class="st"> </span>sp4[<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>, ]</span>
<span id="cb29-3"><a href="SPC.html#cb29-3"></a>s2 &lt;-<span class="st"> </span>sp4[<span class="dv">4</span>, ]</span>
<span id="cb29-4"><a href="SPC.html#cb29-4"></a>s3 &lt;-<span class="st"> </span>sp4[<span class="kw">c</span>(<span class="dv">6</span>, <span class="dv">8</span>, <span class="dv">9</span>), ]</span>
<span id="cb29-5"><a href="SPC.html#cb29-5"></a></span>
<span id="cb29-6"><a href="SPC.html#cb29-6"></a><span class="co"># combine subsets</span></span>
<span id="cb29-7"><a href="SPC.html#cb29-7"></a>s &lt;-<span class="st"> </span><span class="kw">combine</span>(<span class="kw">list</span>(s1, s2, s3))</span>
<span id="cb29-8"><a href="SPC.html#cb29-8"></a></span>
<span id="cb29-9"><a href="SPC.html#cb29-9"></a><span class="co"># double-check result</span></span>
<span id="cb29-10"><a href="SPC.html#cb29-10"></a><span class="kw">plotSPC</span>(s)</span></code></pre></div>
<p>It is possible to combine <code>SoilProfileCollection</code> objects with different internal structure. The final object will contain the all site and horizon columns from the inputs, possibly creating sparse tables. IDs and horizon depth names are taken from the first object.</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode r codeBlock"><code class="sourceCode r"><span id="cb30-1"><a href="SPC.html#cb30-1"></a><span class="co"># sample data as data.frame objects</span></span>
<span id="cb30-2"><a href="SPC.html#cb30-2"></a><span class="kw">data</span>(sp1)</span>
<span id="cb30-3"><a href="SPC.html#cb30-3"></a><span class="kw">data</span>(sp3)</span>
<span id="cb30-4"><a href="SPC.html#cb30-4"></a></span>
<span id="cb30-5"><a href="SPC.html#cb30-5"></a><span class="co"># rename IDs horizon top / bottom columns</span></span>
<span id="cb30-6"><a href="SPC.html#cb30-6"></a>sp3<span class="op">$</span>newid &lt;-<span class="st"> </span>sp3<span class="op">$</span>id</span>
<span id="cb30-7"><a href="SPC.html#cb30-7"></a>sp3<span class="op">$</span>hztop &lt;-<span class="st"> </span>sp3<span class="op">$</span>top</span>
<span id="cb30-8"><a href="SPC.html#cb30-8"></a>sp3<span class="op">$</span>hzbottom &lt;-<span class="st"> </span>sp3<span class="op">$</span>bottom</span>
<span id="cb30-9"><a href="SPC.html#cb30-9"></a></span>
<span id="cb30-10"><a href="SPC.html#cb30-10"></a><span class="co"># remove originals</span></span>
<span id="cb30-11"><a href="SPC.html#cb30-11"></a>sp3<span class="op">$</span>id &lt;-<span class="st"> </span><span class="ot">NULL</span></span>
<span id="cb30-12"><a href="SPC.html#cb30-12"></a>sp3<span class="op">$</span>top &lt;-<span class="st"> </span><span class="ot">NULL</span></span>
<span id="cb30-13"><a href="SPC.html#cb30-13"></a>sp3<span class="op">$</span>bottom &lt;-<span class="st"> </span><span class="ot">NULL</span></span>
<span id="cb30-14"><a href="SPC.html#cb30-14"></a></span>
<span id="cb30-15"><a href="SPC.html#cb30-15"></a><span class="co"># promote to SoilProfileCollection</span></span>
<span id="cb30-16"><a href="SPC.html#cb30-16"></a><span class="kw">depths</span>(sp1) &lt;-<span class="st"> </span>id <span class="op">~</span><span class="st"> </span>top <span class="op">+</span><span class="st"> </span>bottom</span>
<span id="cb30-17"><a href="SPC.html#cb30-17"></a><span class="kw">depths</span>(sp3) &lt;-<span class="st"> </span>newid <span class="op">~</span><span class="st"> </span>hztop <span class="op">+</span><span class="st"> </span>hzbottom</span>
<span id="cb30-18"><a href="SPC.html#cb30-18"></a></span>
<span id="cb30-19"><a href="SPC.html#cb30-19"></a><span class="co"># label each group via site-level attribute</span></span>
<span id="cb30-20"><a href="SPC.html#cb30-20"></a><span class="kw">site</span>(sp1)<span class="op">$</span>g &lt;-<span class="st"> &#39;sp1&#39;</span></span>
<span id="cb30-21"><a href="SPC.html#cb30-21"></a><span class="kw">site</span>(sp3)<span class="op">$</span>g &lt;-<span class="st"> &#39;sp3&#39;</span></span>
<span id="cb30-22"><a href="SPC.html#cb30-22"></a></span>
<span id="cb30-23"><a href="SPC.html#cb30-23"></a><span class="co"># combine</span></span>
<span id="cb30-24"><a href="SPC.html#cb30-24"></a>x &lt;-<span class="st"> </span><span class="kw">combine</span>(<span class="kw">list</span>(sp1, sp3))</span>
<span id="cb30-25"><a href="SPC.html#cb30-25"></a></span>
<span id="cb30-26"><a href="SPC.html#cb30-26"></a><span class="co"># make grouping variable into a factor for groupedProfilePlot</span></span>
<span id="cb30-27"><a href="SPC.html#cb30-27"></a>x<span class="op">$</span>g &lt;-<span class="st"> </span><span class="kw">factor</span>(x<span class="op">$</span>g)</span>
<span id="cb30-28"><a href="SPC.html#cb30-28"></a></span>
<span id="cb30-29"><a href="SPC.html#cb30-29"></a><span class="co"># check results</span></span>
<span id="cb30-30"><a href="SPC.html#cb30-30"></a><span class="kw">str</span>(x)</span>
<span id="cb30-31"><a href="SPC.html#cb30-31"></a></span>
<span id="cb30-32"><a href="SPC.html#cb30-32"></a><span class="co"># graphical check</span></span>
<span id="cb30-33"><a href="SPC.html#cb30-33"></a><span class="co"># convert character horizon IDs into numeric</span></span>
<span id="cb30-34"><a href="SPC.html#cb30-34"></a>x<span class="op">$</span>zzz &lt;-<span class="st"> </span><span class="kw">as.numeric</span>(<span class="kw">hzID</span>(x))</span>
<span id="cb30-35"><a href="SPC.html#cb30-35"></a><span class="kw">plotSPC</span>(x, <span class="dt">color=</span><span class="st">&#39;zzz&#39;</span>)</span>
<span id="cb30-36"><a href="SPC.html#cb30-36"></a><span class="kw">groupedProfilePlot</span>(x, <span class="st">&#39;g&#39;</span>, <span class="dt">color=</span><span class="st">&#39;zzz&#39;</span>, <span class="dt">group.name.offset =</span> <span class="dv">-15</span>)</span></code></pre></div>
<div id="splitting" class="section level3">
<h3><span class="header-section-number">2.9.1</span> Splitting</h3>
<p>The inverse of <code>combine</code> is <code>split</code>: subsets of the <code>SoilProfileCollection</code> are split into list elements, each containing a new <code>SoilProfileCollection</code>.</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode r codeBlock"><code class="sourceCode r"><span id="cb31-1"><a href="SPC.html#cb31-1"></a><span class="co"># continuing from above</span></span>
<span id="cb31-2"><a href="SPC.html#cb31-2"></a><span class="co"># split subsets of x into a list of SoilProfileCollection objcts using site-level attribute &#39;g&#39;</span></span>
<span id="cb31-3"><a href="SPC.html#cb31-3"></a>res &lt;-<span class="st"> </span><span class="kw">split</span>(x, <span class="st">&#39;g&#39;</span>)</span>
<span id="cb31-4"><a href="SPC.html#cb31-4"></a><span class="kw">str</span>(res, <span class="dv">1</span>)</span></code></pre></div>
</div>
<div id="duplication" class="section level3">
<h3><span class="header-section-number">2.9.2</span> Duplication</h3>
<div class="sourceCode" id="cb32"><pre class="sourceCode r codeBlock"><code class="sourceCode r"><span id="cb32-1"><a href="SPC.html#cb32-1"></a>d &lt;-<span class="st"> </span><span class="kw">duplicate</span>(sp4[<span class="dv">1</span>, ], <span class="dt">times =</span> <span class="dv">8</span>)</span>
<span id="cb32-2"><a href="SPC.html#cb32-2"></a><span class="kw">par</span>(<span class="dt">mar=</span><span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">2</span>,<span class="dv">0</span>,<span class="dv">4</span>))</span>
<span id="cb32-3"><a href="SPC.html#cb32-3"></a><span class="kw">plotSPC</span>(d, <span class="dt">color =</span> <span class="st">&#39;ex_Ca_to_Mg&#39;</span>)</span></code></pre></div>
<p><img src="aqpbook_files/figure-html/unnamed-chunk-7-1.png" style="display: block; margin: auto;" /></p>
</div>
</div>
<div id="plotting-soilprofilecollection-objects" class="section level2">
<h2><span class="header-section-number">2.10</span> Plotting SoilProfileCollection Objects</h2>
<p>The <code>plotSPC()</code> method for <code>SoilProfileCollection</code> objects generates sketches of profiles within the collection based on horizon boundaries, vertically aligned to an integer sequence from 1 to the number of profiles. Horizon names are automatically extracted from a horizon-level attribute <code>name</code> (if present), or via an alternate attributed given as an argument: <code>name='column.name'</code>. Horizon colors are automatically generated from the horizon-level attribute <code>soil_color</code>, or any other attribute of <strong>R</strong>-compatible color description given as an argument: <code>color='column.name'</code>. This function is highly customizable, therefore, it is prudent to consult <code>help(plotSPC)</code> from time to time. Soil colors in Munsell notation can be converted to <strong>R</strong>-compatible colors via <code>munsell2rgb()</code>.</p>
<div id="making-adjustments" class="section level3">
<h3><span class="header-section-number">2.10.1</span> Making Adjustments</h3>
<p>The <code>explainPlotSPC()</code> function is helpful for adjusting some of the more obscure arguments to <code>plotSPC()</code>.</p>
<p>A basic plot with debugging information overlayed.</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode r codeBlock"><code class="sourceCode r"><span id="cb33-1"><a href="SPC.html#cb33-1"></a><span class="kw">par</span>(<span class="dt">mar=</span><span class="kw">c</span>(<span class="dv">4</span>,<span class="dv">3</span>,<span class="dv">2</span>,<span class="dv">2</span>))</span>
<span id="cb33-2"><a href="SPC.html#cb33-2"></a><span class="kw">explainPlotSPC</span>(sp4, <span class="dt">name=</span><span class="st">&#39;name&#39;</span>)</span></code></pre></div>
<p><img src="aqpbook_files/figure-html/unnamed-chunk-8-1.png" style="display: block; margin: auto;" /></p>
<p>Make sketches wider.</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode r codeBlock"><code class="sourceCode r"><span id="cb34-1"><a href="SPC.html#cb34-1"></a><span class="kw">par</span>(<span class="dt">mar=</span><span class="kw">c</span>(<span class="dv">4</span>,<span class="dv">3</span>,<span class="dv">2</span>,<span class="dv">2</span>))</span>
<span id="cb34-2"><a href="SPC.html#cb34-2"></a><span class="kw">explainPlotSPC</span>(sp4, <span class="dt">name=</span><span class="st">&#39;name&#39;</span>, <span class="dt">width=</span><span class="fl">0.3</span>)</span></code></pre></div>
<p><img src="aqpbook_files/figure-html/unnamed-chunk-9-1.png" style="display: block; margin: auto;" /></p>
<p>Move soil surface at 0cm “down” 5cm.</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode r codeBlock"><code class="sourceCode r"><span id="cb35-1"><a href="SPC.html#cb35-1"></a><span class="kw">par</span>(<span class="dt">mar=</span><span class="kw">c</span>(<span class="dv">4</span>,<span class="dv">3</span>,<span class="dv">2</span>,<span class="dv">2</span>))</span>
<span id="cb35-2"><a href="SPC.html#cb35-2"></a><span class="kw">explainPlotSPC</span>(sp4, <span class="dt">name=</span><span class="st">&#39;name&#39;</span>, <span class="dt">y.offset=</span><span class="dv">5</span>)</span></code></pre></div>
<p><img src="aqpbook_files/figure-html/unnamed-chunk-10-1.png" style="display: block; margin: auto;" /></p>
<p>Move soil surface at 0cm “up” 10cm; useful for sketches of shallow profiles.</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode r codeBlock"><code class="sourceCode r"><span id="cb36-1"><a href="SPC.html#cb36-1"></a><span class="kw">par</span>(<span class="dt">mar=</span><span class="kw">c</span>(<span class="dv">4</span>,<span class="dv">3</span>,<span class="dv">2</span>,<span class="dv">2</span>))</span>
<span id="cb36-2"><a href="SPC.html#cb36-2"></a><span class="kw">explainPlotSPC</span>(sp4, <span class="dt">name=</span><span class="st">&#39;name&#39;</span>, <span class="dt">y.offset=</span><span class="op">-</span><span class="dv">10</span>)</span></code></pre></div>
<p><img src="aqpbook_files/figure-html/unnamed-chunk-11-1.png" style="display: block; margin: auto;" /></p>
<p>Scale depths by 50%.</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode r codeBlock"><code class="sourceCode r"><span id="cb37-1"><a href="SPC.html#cb37-1"></a><span class="kw">par</span>(<span class="dt">mar=</span><span class="kw">c</span>(<span class="dv">4</span>,<span class="dv">3</span>,<span class="dv">2</span>,<span class="dv">2</span>))</span>
<span id="cb37-2"><a href="SPC.html#cb37-2"></a><span class="kw">explainPlotSPC</span>(sp4, <span class="dt">name=</span><span class="st">&#39;name&#39;</span>, <span class="dt">scaling.factor=</span><span class="fl">0.5</span>)</span></code></pre></div>
<p><img src="aqpbook_files/figure-html/unnamed-chunk-12-1.png" style="display: block; margin: auto;" /></p>
<p>A graphical explanation of how profiles are re-arranged via <code>plot.order</code> argument.</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode r codeBlock"><code class="sourceCode r"><span id="cb38-1"><a href="SPC.html#cb38-1"></a><span class="kw">par</span>(<span class="dt">mar=</span><span class="kw">c</span>(<span class="dv">4</span>,<span class="dv">3</span>,<span class="dv">2</span>,<span class="dv">2</span>))</span>
<span id="cb38-2"><a href="SPC.html#cb38-2"></a><span class="kw">explainPlotSPC</span>(sp4, <span class="dt">name=</span><span class="st">&#39;name&#39;</span>, <span class="dt">plot.order=</span><span class="kw">length</span>(sp4)<span class="op">:</span><span class="dv">1</span>)</span></code></pre></div>
<p><img src="aqpbook_files/figure-html/unnamed-chunk-13-1.png" style="display: block; margin: auto;" /></p>
<p>Leave room for an additional 2 profile sketches.</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode r codeBlock"><code class="sourceCode r"><span id="cb39-1"><a href="SPC.html#cb39-1"></a><span class="kw">par</span>(<span class="dt">mar=</span><span class="kw">c</span>(<span class="dv">4</span>,<span class="dv">3</span>,<span class="dv">2</span>,<span class="dv">2</span>))</span>
<span id="cb39-2"><a href="SPC.html#cb39-2"></a><span class="kw">explainPlotSPC</span>(sp4, <span class="dt">name=</span><span class="st">&#39;name&#39;</span>, <span class="dt">n=</span><span class="kw">length</span>(sp4) <span class="op">+</span><span class="st"> </span><span class="dv">2</span>)</span></code></pre></div>
<p><img src="aqpbook_files/figure-html/unnamed-chunk-14-1.png" style="display: block; margin: auto;" /></p>
<div id="small-soilprofilecollections" class="section level4">
<h4><span class="header-section-number">2.10.1.1</span> Small SoilProfileCollections</h4>
<p>Making quality figures with fewer than 5 soil profiles usually requires more customization of the basic call to <code>plotSPC</code>. In general, the following are a good starting point:</p>
<ul>
<li>shrink margins and disable clipping with <code>par</code></li>
<li>adjust output graphic device (e.g. <code>png()</code>) dimensions and resolution</li>
<li>increase font size with <code>cex.names</code></li>
<li>adjust sketch width with <code>width</code>, typically within 0.15-0.35</li>
<li>move depth axis to the left with negative <code>axis.line.offset</code> values</li>
</ul>
<p>Get some example data from the Official Series Descriptions.</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode r codeBlock"><code class="sourceCode r"><span id="cb40-1"><a href="SPC.html#cb40-1"></a><span class="kw">library</span>(soilDB)</span>
<span id="cb40-2"><a href="SPC.html#cb40-2"></a>x &lt;-<span class="st"> </span><span class="kw">fetchOSD</span>(<span class="kw">c</span>(<span class="st">&#39;appling&#39;</span>, <span class="st">&#39;cecil&#39;</span>, <span class="st">&#39;bonneau&#39;</span>))</span></code></pre></div>
<p>Using 5x6 inch output device.</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode r codeBlock"><code class="sourceCode r"><span id="cb41-1"><a href="SPC.html#cb41-1"></a><span class="co"># set margins and turn off clipping</span></span>
<span id="cb41-2"><a href="SPC.html#cb41-2"></a><span class="kw">par</span>(<span class="dt">mar=</span><span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">2</span>,<span class="dv">0</span>,<span class="dv">4</span>), <span class="dt">xpd=</span><span class="ot">NA</span>)</span>
<span id="cb41-3"><a href="SPC.html#cb41-3"></a><span class="kw">plotSPC</span>(x[<span class="dv">1</span>, ], <span class="dt">cex.names=</span><span class="dv">1</span>)</span></code></pre></div>
<p><img src="aqpbook_files/figure-html/unnamed-chunk-16-1.png" style="display: block; margin: auto;" /></p>
<p>Using 7x6 inch output device, slight adjustments to <code>width</code> usually required.</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode r codeBlock"><code class="sourceCode r"><span id="cb42-1"><a href="SPC.html#cb42-1"></a><span class="co"># set margins and turn off clipping</span></span>
<span id="cb42-2"><a href="SPC.html#cb42-2"></a><span class="kw">par</span>(<span class="dt">mar=</span><span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">2</span>,<span class="dv">0</span>,<span class="dv">4</span>), <span class="dt">xpd=</span><span class="ot">NA</span>)</span>
<span id="cb42-3"><a href="SPC.html#cb42-3"></a><span class="kw">plotSPC</span>(x[<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>, ], <span class="dt">cex.names=</span><span class="dv">1</span>, <span class="dt">width=</span><span class="fl">0.25</span>)</span></code></pre></div>
<p><img src="aqpbook_files/figure-html/unnamed-chunk-17-1.png" style="display: block; margin: auto;" /></p>
<p>Using 8x6 inch output device, slight adjustments to <code>axis.line.offset</code> and <code>width</code> are usually required.</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode r codeBlock"><code class="sourceCode r"><span id="cb43-1"><a href="SPC.html#cb43-1"></a><span class="co"># set margins and turn off clipping</span></span>
<span id="cb43-2"><a href="SPC.html#cb43-2"></a><span class="kw">par</span>(<span class="dt">mar=</span><span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">2</span>,<span class="dv">0</span>,<span class="dv">4</span>), <span class="dt">xpd=</span><span class="ot">NA</span>)</span>
<span id="cb43-3"><a href="SPC.html#cb43-3"></a><span class="kw">plotSPC</span>(x, <span class="dt">cex.names=</span><span class="dv">1</span>, <span class="dt">axis.line.offset =</span> <span class="fl">-0.1</span>, <span class="dt">width=</span><span class="fl">0.3</span>)</span></code></pre></div>
<p><img src="aqpbook_files/figure-html/unnamed-chunk-18-1.png" style="display: block; margin: auto;" /></p>
</div>
</div>
<div id="relative-horizontal-positioning" class="section level3">
<h3><span class="header-section-number">2.10.2</span> Relative Horizontal Positioning</h3>
<p>Relative horizontal positioning via <code>relative.pos</code> argument. Can be used with <code>plot.order</code> but be careful: <code>relative.pos</code> must be specified in the <em>final</em> ordering of profiles. See <code>?plotSPC</code> for details.</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode r codeBlock"><code class="sourceCode r"><span id="cb44-1"><a href="SPC.html#cb44-1"></a><span class="kw">par</span>(<span class="dt">mar=</span><span class="kw">c</span>(<span class="dv">4</span>,<span class="dv">3</span>,<span class="dv">2</span>,<span class="dv">2</span>))</span>
<span id="cb44-2"><a href="SPC.html#cb44-2"></a>pos &lt;-<span class="st"> </span><span class="kw">jitter</span>(<span class="dv">1</span><span class="op">:</span><span class="kw">length</span>(sp4))</span>
<span id="cb44-3"><a href="SPC.html#cb44-3"></a><span class="kw">explainPlotSPC</span>(sp4, <span class="dt">name=</span><span class="st">&#39;name&#39;</span>, <span class="dt">relative.pos=</span>pos)</span></code></pre></div>
<p><img src="aqpbook_files/figure-html/unnamed-chunk-19-1.png" style="display: block; margin: auto;" /></p>
<p>Relative positioning works well when the vector of positions is close to the default spacing along an integer sequence, but not when positions are closer than the width of a profile sketch.</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode r codeBlock"><code class="sourceCode r"><span id="cb45-1"><a href="SPC.html#cb45-1"></a><span class="kw">par</span>(<span class="dt">mar=</span><span class="kw">c</span>(<span class="dv">4</span>,<span class="dv">3</span>,<span class="dv">2</span>,<span class="dv">2</span>))</span>
<span id="cb45-2"><a href="SPC.html#cb45-2"></a>pos &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">1</span>, <span class="fl">1.2</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">5</span>, <span class="fl">5.2</span>, <span class="dv">7</span>, <span class="dv">8</span>, <span class="dv">9</span>, <span class="dv">10</span>)</span>
<span id="cb45-3"><a href="SPC.html#cb45-3"></a><span class="kw">explainPlotSPC</span>(sp4, <span class="dt">name=</span><span class="st">&#39;name&#39;</span>, <span class="dt">relative.pos=</span>pos)</span></code></pre></div>
<p><img src="aqpbook_files/figure-html/unnamed-chunk-20-1.png" style="display: block; margin: auto;" /></p>
<p>The <code>fixOverlap()</code> function can be used to find a suitable arrangement of profiles based on a compromise between the suggested relative positions and minimization of overlap. This is an iterative procedure, based on random perturbations of overlapping profiles, therefore it is possible for the algorithm to stop at a sub-optimal configuration. Results can be controlled using <code>set.seed()</code>.</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode r codeBlock"><code class="sourceCode r"><span id="cb46-1"><a href="SPC.html#cb46-1"></a><span class="kw">par</span>(<span class="dt">mar=</span><span class="kw">c</span>(<span class="dv">4</span>,<span class="dv">3</span>,<span class="dv">2</span>,<span class="dv">2</span>))</span>
<span id="cb46-2"><a href="SPC.html#cb46-2"></a>new.pos &lt;-<span class="st"> </span><span class="kw">fixOverlap</span>(pos)</span>
<span id="cb46-3"><a href="SPC.html#cb46-3"></a><span class="kw">explainPlotSPC</span>(sp4, <span class="dt">name=</span><span class="st">&#39;name&#39;</span>, <span class="dt">relative.pos=</span>new.pos)</span></code></pre></div>
<p><img src="aqpbook_files/figure-html/unnamed-chunk-21-1.png" style="display: block; margin: auto;" /></p>
<p>There are several parameters available for optimizing horizontal position in the presence of overlap. See <code>?fixOverlap</code> for details and further examples. The <a href="http://ncss-tech.github.io/AQP/aqp/SPC-plotting-ideas.html">SPC plotting ideas tutorial</a> contains several practical examples.</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode r codeBlock"><code class="sourceCode r"><span id="cb47-1"><a href="SPC.html#cb47-1"></a><span class="kw">par</span>(<span class="dt">mar=</span><span class="kw">c</span>(<span class="dv">4</span>,<span class="dv">3</span>,<span class="dv">2</span>,<span class="dv">2</span>))</span>
<span id="cb47-2"><a href="SPC.html#cb47-2"></a>new.pos &lt;-<span class="st"> </span><span class="kw">fixOverlap</span>(pos, <span class="dt">thresh =</span> <span class="fl">0.7</span>)</span>
<span id="cb47-3"><a href="SPC.html#cb47-3"></a><span class="kw">explainPlotSPC</span>(sp4, <span class="dt">name=</span><span class="st">&#39;name&#39;</span>, <span class="dt">relative.pos=</span>new.pos)</span></code></pre></div>
<p><img src="aqpbook_files/figure-html/unnamed-chunk-22-1.png" style="display: block; margin: auto;" /></p>
</div>
<div id="thematic-sketches" class="section level3">
<h3><span class="header-section-number">2.10.3</span> Thematic Sketches</h3>
<p>Horizon-level attributes can be symbolized with color, in this case using the horizon-level attribute “clay”:</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode r codeBlock"><code class="sourceCode r"><span id="cb48-1"><a href="SPC.html#cb48-1"></a><span class="co"># plot again, this time using new colors</span></span>
<span id="cb48-2"><a href="SPC.html#cb48-2"></a><span class="kw">par</span>(<span class="dt">mar=</span><span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">3</span>,<span class="dv">0</span>)) <span class="co"># tighter figure margins</span></span>
<span id="cb48-3"><a href="SPC.html#cb48-3"></a><span class="kw">plotSPC</span>(sp4, <span class="dt">name=</span><span class="st">&#39;name&#39;</span>, <span class="dt">color=</span><span class="st">&#39;clay&#39;</span>, <span class="dt">col.label=</span><span class="st">&#39;Clay Content (%)&#39;</span>)</span></code></pre></div>
<p><img src="aqpbook_files/figure-html/unnamed-chunk-23-1.png" style="display: block; margin: auto;" /></p>
<p>Use a different set of colors.</p>
<div class="sourceCode" id="cb49"><pre class="sourceCode r codeBlock"><code class="sourceCode r"><span id="cb49-1"><a href="SPC.html#cb49-1"></a><span class="co"># plot again, this time using new colors</span></span>
<span id="cb49-2"><a href="SPC.html#cb49-2"></a><span class="kw">par</span>(<span class="dt">mar=</span><span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">3</span>,<span class="dv">0</span>)) <span class="co"># tighter figure margins</span></span>
<span id="cb49-3"><a href="SPC.html#cb49-3"></a><span class="kw">plotSPC</span>(sp4, <span class="dt">name=</span><span class="st">&#39;name&#39;</span>, <span class="dt">color=</span><span class="st">&#39;clay&#39;</span>, <span class="dt">col.palette=</span>viridis<span class="op">::</span><span class="kw">viridis</span>(<span class="dv">10</span>), <span class="dt">col.label=</span><span class="st">&#39;Clay Content (%)&#39;</span>)</span></code></pre></div>
<p><img src="aqpbook_files/figure-html/unnamed-chunk-24-1.png" style="display: block; margin: auto;" /></p>
<p>Categorical properties can also be used to make a thematic sketch. Colors are interpolated when there are more classes than colors provided by <code>col.palette</code>.</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode r codeBlock"><code class="sourceCode r"><span id="cb50-1"><a href="SPC.html#cb50-1"></a><span class="kw">par</span>(<span class="dt">mar=</span><span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">3</span>,<span class="dv">0</span>)) <span class="co"># tighter figure margins</span></span>
<span id="cb50-2"><a href="SPC.html#cb50-2"></a><span class="kw">plotSPC</span>(sp4, <span class="dt">name=</span><span class="st">&#39;name&#39;</span>, <span class="dt">color=</span><span class="st">&#39;name&#39;</span>, <span class="dt">col.palette=</span>RColorBrewer<span class="op">::</span><span class="kw">brewer.pal</span>(<span class="dv">5</span>, <span class="st">&#39;Set1&#39;</span>), <span class="dt">col.label=</span><span class="st">&#39;Original Horizon Name&#39;</span>)</span></code></pre></div>
<p><img src="aqpbook_files/figure-html/unnamed-chunk-25-1.png" style="display: block; margin: auto;" /></p>
<p>Try with <a href="http://ncss-tech.github.io/AQP/aqp/gen-hz-assignment.html">generalized horizon labels</a>.</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode r codeBlock"><code class="sourceCode r"><span id="cb51-1"><a href="SPC.html#cb51-1"></a><span class="kw">par</span>(<span class="dt">mar=</span><span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">3</span>,<span class="dv">0</span>)) <span class="co"># tighter figure margins</span></span>
<span id="cb51-2"><a href="SPC.html#cb51-2"></a></span>
<span id="cb51-3"><a href="SPC.html#cb51-3"></a><span class="co"># generalize horizon names into 3 groups</span></span>
<span id="cb51-4"><a href="SPC.html#cb51-4"></a>sp4<span class="op">$</span>genhz &lt;-<span class="st"> </span><span class="kw">generalize.hz</span>(sp4<span class="op">$</span>name, <span class="dt">new =</span> <span class="kw">c</span>(<span class="st">&#39;A&#39;</span>, <span class="st">&#39;AB&#39;</span>, <span class="st">&#39;Bt&#39;</span>), <span class="dt">pat=</span><span class="kw">c</span>(<span class="st">&#39;A[0-9]?&#39;</span>, <span class="st">&#39;AB&#39;</span>, <span class="st">&#39;^Bt&#39;</span>))</span>
<span id="cb51-5"><a href="SPC.html#cb51-5"></a></span>
<span id="cb51-6"><a href="SPC.html#cb51-6"></a><span class="kw">plotSPC</span>(sp4, <span class="dt">name=</span><span class="st">&#39;name&#39;</span>, <span class="dt">color=</span><span class="st">&#39;genhz&#39;</span>, <span class="dt">col.palette=</span>RColorBrewer<span class="op">::</span><span class="kw">brewer.pal</span>(<span class="dv">3</span>, <span class="st">&#39;Spectral&#39;</span>), <span class="dt">col.label=</span><span class="st">&#39;Generalized Horizon Name&#39;</span>)</span></code></pre></div>
<p><img src="aqpbook_files/figure-html/unnamed-chunk-26-1.png" style="display: block; margin: auto;" /></p>
<p>Horizon-level attributes that represent a volume fraction (e.g. coarse-fragment percentage) can be added to an existing figure:</p>
<div class="sourceCode" id="cb52"><pre class="sourceCode r codeBlock"><code class="sourceCode r"><span id="cb52-1"><a href="SPC.html#cb52-1"></a><span class="kw">par</span>(<span class="dt">mar=</span><span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">3</span>,<span class="dv">0</span>)) <span class="co"># tighter figure margins</span></span>
<span id="cb52-2"><a href="SPC.html#cb52-2"></a>sp4<span class="op">$</span>frag_pct &lt;-<span class="st"> </span>sp4<span class="op">$</span>CF <span class="op">*</span><span class="st"> </span><span class="dv">100</span> <span class="co"># convert fraction -&gt; percent</span></span>
<span id="cb52-3"><a href="SPC.html#cb52-3"></a><span class="kw">plotSPC</span>(sp4, <span class="dt">name=</span><span class="st">&#39;name&#39;</span>, <span class="dt">color=</span><span class="st">&#39;frag_pct&#39;</span>)</span>
<span id="cb52-4"><a href="SPC.html#cb52-4"></a><span class="kw">addVolumeFraction</span>(sp4, <span class="st">&#39;frag_pct&#39;</span>) <span class="co"># symbolize volume fraction data</span></span></code></pre></div>
<p><img src="aqpbook_files/figure-html/plotting-vol-fraction-1.png" style="display: block; margin: auto;" /></p>
</div>
<div id="depth-intervals" class="section level3">
<h3><span class="header-section-number">2.10.4</span> Depth Intervals</h3>
<p>Annotation of depth-intervals can be accomplished using “brackets”:</p>
<div class="sourceCode" id="cb53"><pre class="sourceCode r codeBlock"><code class="sourceCode r"><span id="cb53-1"><a href="SPC.html#cb53-1"></a><span class="co"># extract top/bottom depths associated with all A horizons</span></span>
<span id="cb53-2"><a href="SPC.html#cb53-2"></a><span class="co"># return as a single data.frame / profile</span></span>
<span id="cb53-3"><a href="SPC.html#cb53-3"></a>f &lt;-<span class="st"> </span><span class="cf">function</span>(i) {</span>
<span id="cb53-4"><a href="SPC.html#cb53-4"></a>  <span class="co"># horizons as a data.frame</span></span>
<span id="cb53-5"><a href="SPC.html#cb53-5"></a>  h &lt;-<span class="st"> </span><span class="kw">horizons</span>(i)</span>
<span id="cb53-6"><a href="SPC.html#cb53-6"></a>  <span class="co"># index &quot;A&quot; horizons</span></span>
<span id="cb53-7"><a href="SPC.html#cb53-7"></a>  idx &lt;-<span class="st"> </span><span class="kw">grep</span>(<span class="st">&#39;^A&#39;</span>, h<span class="op">$</span>name)</span>
<span id="cb53-8"><a href="SPC.html#cb53-8"></a>  <span class="co"># current profile ID</span></span>
<span id="cb53-9"><a href="SPC.html#cb53-9"></a>  idn &lt;-<span class="st"> </span><span class="kw">idname</span>(i)</span>
<span id="cb53-10"><a href="SPC.html#cb53-10"></a>  this.id &lt;-<span class="st"> </span>h[[idn]]</span>
<span id="cb53-11"><a href="SPC.html#cb53-11"></a>  </span>
<span id="cb53-12"><a href="SPC.html#cb53-12"></a>  res &lt;-<span class="st"> </span><span class="kw">data.frame</span>(</span>
<span id="cb53-13"><a href="SPC.html#cb53-13"></a>    <span class="dt">id =</span> this.id,</span>
<span id="cb53-14"><a href="SPC.html#cb53-14"></a>    <span class="dt">top =</span> <span class="kw">min</span>(h<span class="op">$</span>top[idx]), </span>
<span id="cb53-15"><a href="SPC.html#cb53-15"></a>    <span class="dt">bottom =</span> <span class="kw">max</span>(h<span class="op">$</span>bottom[idx], <span class="dt">na.rm=</span><span class="ot">TRUE</span>)</span>
<span id="cb53-16"><a href="SPC.html#cb53-16"></a>  )</span>
<span id="cb53-17"><a href="SPC.html#cb53-17"></a>  </span>
<span id="cb53-18"><a href="SPC.html#cb53-18"></a>  <span class="co"># set profile ID name</span></span>
<span id="cb53-19"><a href="SPC.html#cb53-19"></a>  <span class="kw">names</span>(res)[<span class="dv">1</span>] &lt;-<span class="st"> </span>idn</span>
<span id="cb53-20"><a href="SPC.html#cb53-20"></a>  </span>
<span id="cb53-21"><a href="SPC.html#cb53-21"></a>  <span class="kw">return</span>(res)</span>
<span id="cb53-22"><a href="SPC.html#cb53-22"></a>}</span>
<span id="cb53-23"><a href="SPC.html#cb53-23"></a></span>
<span id="cb53-24"><a href="SPC.html#cb53-24"></a><span class="co"># apply function to each profile in sp4, result is a list</span></span>
<span id="cb53-25"><a href="SPC.html#cb53-25"></a>a &lt;-<span class="st"> </span><span class="kw">profileApply</span>(sp4, f, <span class="dt">simplify =</span> <span class="ot">FALSE</span>, <span class="dt">frameify =</span> <span class="ot">TRUE</span>)</span>
<span id="cb53-26"><a href="SPC.html#cb53-26"></a></span>
<span id="cb53-27"><a href="SPC.html#cb53-27"></a>a</span></code></pre></div>
<pre class="outputBlock"><code>##                id top bottom
## 1          colusa   0      8
## 2          colusa   0      8
## 3          colusa   0      8
## 4          colusa   0      8
## 5           glenn   0      9
## 6           glenn   0      9
## 7           kings   0      4
## 8           kings   0      4
## 9           kings   0      4
## 10       mariposa   0      3
## 11       mariposa   0      3
## 12       mariposa   0      3
## 13       mariposa   0      3
## 14      mendocino   0      2
## 15      mendocino   0      2
## 16      mendocino   0      2
## 17           napa   0      6
## 18           napa   0      6
## 19     san benito   0      8
## 20     san benito   0      8
## 21         shasta   0      3
## 22         shasta   0      3
## 23 shasta-trinity   0     12
## 24 shasta-trinity   0     12
## 25 shasta-trinity   0     12
## 26 shasta-trinity   0     12
## 27 shasta-trinity   0     12
## 28         tehama   0      3
## 29         tehama   0      3
## 30         tehama   0      3</code></pre>
<div class="sourceCode" id="cb55"><pre class="sourceCode r codeBlock"><code class="sourceCode r"><span id="cb55-1"><a href="SPC.html#cb55-1"></a><span class="kw">par</span>(<span class="dt">mar=</span><span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>)) <span class="co"># tighter figure margins</span></span>
<span id="cb55-2"><a href="SPC.html#cb55-2"></a><span class="kw">plotSPC</span>(sp4, <span class="dt">name=</span><span class="st">&#39;name&#39;</span>)</span>
<span id="cb55-3"><a href="SPC.html#cb55-3"></a><span class="co"># annotate with brackets</span></span>
<span id="cb55-4"><a href="SPC.html#cb55-4"></a><span class="kw">addBracket</span>(a, <span class="dt">col=</span><span class="st">&#39;red&#39;</span>)</span></code></pre></div>
<p><img src="aqpbook_files/figure-html/unnamed-chunk-27-1.png" style="display: block; margin: auto;" /></p>
<p>It is possible to arrange profile sketches by site-level grouping variable:</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode r codeBlock"><code class="sourceCode r"><span id="cb56-1"><a href="SPC.html#cb56-1"></a><span class="co"># use improvised site-level attribute &#39;group&#39; </span></span>
<span id="cb56-2"><a href="SPC.html#cb56-2"></a><span class="kw">par</span>(<span class="dt">mar=</span><span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>)) <span class="co"># tighter figure margins</span></span>
<span id="cb56-3"><a href="SPC.html#cb56-3"></a><span class="kw">groupedProfilePlot</span>(sp4, <span class="dt">groups=</span><span class="st">&#39;group&#39;</span>)</span>
<span id="cb56-4"><a href="SPC.html#cb56-4"></a><span class="co"># note that depth brackets &quot;know&quot; which profiles to use</span></span>
<span id="cb56-5"><a href="SPC.html#cb56-5"></a><span class="kw">addBracket</span>(a, <span class="dt">col=</span><span class="st">&#39;red&#39;</span>)</span></code></pre></div>
<p><img src="aqpbook_files/figure-html/unnamed-chunk-28-1.png" style="display: block; margin: auto;" /></p>
<p>There need not be brackets for all profiles in a collection:</p>
<div class="sourceCode" id="cb57"><pre class="sourceCode r codeBlock"><code class="sourceCode r"><span id="cb57-1"><a href="SPC.html#cb57-1"></a><span class="co"># add a label for each bracket</span></span>
<span id="cb57-2"><a href="SPC.html#cb57-2"></a>a.sub &lt;-<span class="st"> </span>a[<span class="dv">1</span><span class="op">:</span><span class="dv">4</span>, ]</span>
<span id="cb57-3"><a href="SPC.html#cb57-3"></a><span class="co"># tighter figure margins</span></span>
<span id="cb57-4"><a href="SPC.html#cb57-4"></a><span class="kw">par</span>(<span class="dt">mar=</span><span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>))</span>
<span id="cb57-5"><a href="SPC.html#cb57-5"></a><span class="kw">groupedProfilePlot</span>(sp4, <span class="dt">groups=</span><span class="st">&#39;group&#39;</span>)</span>
<span id="cb57-6"><a href="SPC.html#cb57-6"></a><span class="co"># note that depth brackets &quot;know which profiles to use&quot;</span></span>
<span id="cb57-7"><a href="SPC.html#cb57-7"></a><span class="kw">addBracket</span>(a.sub, <span class="dt">col=</span><span class="st">&#39;red&#39;</span>)</span></code></pre></div>
<p><img src="aqpbook_files/figure-html/unnamed-chunk-29-1.png" style="display: block; margin: auto;" /></p>
<p>When bottom depths are missing an arrow is used:</p>
<div class="sourceCode" id="cb58"><pre class="sourceCode r codeBlock"><code class="sourceCode r"><span id="cb58-1"><a href="SPC.html#cb58-1"></a>a<span class="op">$</span>bottom &lt;-<span class="st"> </span><span class="ot">NA</span></span>
<span id="cb58-2"><a href="SPC.html#cb58-2"></a><span class="co"># tighter figure margins</span></span>
<span id="cb58-3"><a href="SPC.html#cb58-3"></a><span class="kw">par</span>(<span class="dt">mar=</span><span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>))</span>
<span id="cb58-4"><a href="SPC.html#cb58-4"></a><span class="kw">groupedProfilePlot</span>(sp4, <span class="dt">groups=</span><span class="st">&#39;group&#39;</span>)</span>
<span id="cb58-5"><a href="SPC.html#cb58-5"></a><span class="co"># note that depth brackets &quot;know which profiles to use&quot;</span></span>
<span id="cb58-6"><a href="SPC.html#cb58-6"></a><span class="kw">addBracket</span>(a, <span class="dt">col=</span><span class="st">&#39;red&#39;</span>)</span></code></pre></div>
<p><img src="aqpbook_files/figure-html/unnamed-chunk-30-1.png" style="display: block; margin: auto;" /></p>
<p>Further customization of brackets:</p>
<div class="sourceCode" id="cb59"><pre class="sourceCode r codeBlock"><code class="sourceCode r"><span id="cb59-1"><a href="SPC.html#cb59-1"></a><span class="co"># add a label for each bracket</span></span>
<span id="cb59-2"><a href="SPC.html#cb59-2"></a>a<span class="op">$</span>label &lt;-<span class="st"> </span><span class="kw">site</span>(sp4)<span class="op">$</span>id</span>
<span id="cb59-3"><a href="SPC.html#cb59-3"></a><span class="co"># tighter figure margins</span></span>
<span id="cb59-4"><a href="SPC.html#cb59-4"></a><span class="kw">par</span>(<span class="dt">mar=</span><span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>))</span>
<span id="cb59-5"><a href="SPC.html#cb59-5"></a><span class="kw">groupedProfilePlot</span>(sp4, <span class="dt">groups=</span><span class="st">&#39;group&#39;</span>)</span>
<span id="cb59-6"><a href="SPC.html#cb59-6"></a><span class="co"># note that depth brackets &quot;know which profiles to use&quot;</span></span>
<span id="cb59-7"><a href="SPC.html#cb59-7"></a><span class="kw">addBracket</span>(a, <span class="dt">col=</span><span class="st">&#39;red&#39;</span>, <span class="dt">label.cex =</span> <span class="fl">0.75</span>, <span class="dt">missing.bottom.depth =</span> <span class="dv">25</span>)</span></code></pre></div>
<p><img src="aqpbook_files/figure-html/unnamed-chunk-31-1.png" style="display: block; margin: auto;" /></p>
<p>Further customization of brackets:</p>
<div class="sourceCode" id="cb60"><pre class="sourceCode r codeBlock"><code class="sourceCode r"><span id="cb60-1"><a href="SPC.html#cb60-1"></a><span class="co"># copy root-restricting features </span></span>
<span id="cb60-2"><a href="SPC.html#cb60-2"></a>a &lt;-<span class="st"> </span><span class="kw">restrictions</span>(sp4)</span>
<span id="cb60-3"><a href="SPC.html#cb60-3"></a></span>
<span id="cb60-4"><a href="SPC.html#cb60-4"></a><span class="co"># add a label for each bracket, using restrictive feature &#39;kind&#39;</span></span>
<span id="cb60-5"><a href="SPC.html#cb60-5"></a><span class="co"># addBracket() looks for a column called `label`</span></span>
<span id="cb60-6"><a href="SPC.html#cb60-6"></a>a<span class="op">$</span>label &lt;-<span class="st"> </span>a<span class="op">$</span>kind</span>
<span id="cb60-7"><a href="SPC.html#cb60-7"></a></span>
<span id="cb60-8"><a href="SPC.html#cb60-8"></a><span class="co"># plot with tighter margings</span></span>
<span id="cb60-9"><a href="SPC.html#cb60-9"></a><span class="kw">par</span>(<span class="dt">mar=</span><span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>))</span>
<span id="cb60-10"><a href="SPC.html#cb60-10"></a><span class="kw">plotSPC</span>(sp4, <span class="dt">max.depth =</span> <span class="dv">75</span>)</span>
<span id="cb60-11"><a href="SPC.html#cb60-11"></a></span>
<span id="cb60-12"><a href="SPC.html#cb60-12"></a><span class="co"># add restrictions using vertical bars</span></span>
<span id="cb60-13"><a href="SPC.html#cb60-13"></a><span class="kw">addBracket</span>(a, <span class="dt">col=</span><span class="st">&#39;red&#39;</span>, <span class="dt">label.cex =</span> <span class="fl">0.75</span>, <span class="dt">tick.length =</span> <span class="dv">0</span>, <span class="dt">lwd=</span><span class="dv">3</span>)</span></code></pre></div>
<p><img src="aqpbook_files/figure-html/unnamed-chunk-32-1.png" style="display: block; margin: auto;" /></p>
<div id="notes-1" class="section level4">
<h4><span class="header-section-number">2.10.4.1</span> Notes</h4>
<p>These functions (<code>addBracket</code>, <code>addDiagnosticBracket</code>, and <code>addVolumeFraction</code>) will automatically compensate for alternative sketch ordering or relative positioning.</p>
</div>
</div>
<div id="svg-output-for-use-in-page-layout-tools" class="section level3">
<h3><span class="header-section-number">2.10.5</span> SVG Output for Use in Page Layout Tools</h3>
<p>Sketches for use in layout tools such as Adobe Illustrator or Inkscape should be stored in a vector file format. SVG is compatible with most software titles. WMF output is compatible with MS Office tools and can be written with the <code>win.metafile()</code> function.</p>
<div class="sourceCode" id="cb61"><pre class="sourceCode r codeBlock"><code class="sourceCode r"><span id="cb61-1"><a href="SPC.html#cb61-1"></a><span class="kw">svg</span>(<span class="dt">filename =</span> <span class="st">&#39;e:/temp/fig.svg&#39;</span>, <span class="dt">width=</span><span class="dv">7</span>, <span class="dt">height=</span><span class="dv">6</span>, <span class="dt">pointsize =</span> <span class="dv">12</span>, <span class="dt">family =</span> <span class="st">&#39;sans&#39;</span>)</span>
<span id="cb61-2"><a href="SPC.html#cb61-2"></a></span>
<span id="cb61-3"><a href="SPC.html#cb61-3"></a><span class="kw">par</span>(<span class="dt">mar=</span><span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">2</span>,<span class="dv">0</span>,<span class="dv">4</span>), <span class="dt">xpd=</span><span class="ot">NA</span>)</span>
<span id="cb61-4"><a href="SPC.html#cb61-4"></a><span class="kw">plotSPC</span>(x, <span class="dt">cex.names=</span><span class="dv">1</span>, <span class="dt">axis.line.offset =</span> <span class="fl">-0.2</span>, <span class="dt">width=</span><span class="fl">0.3</span>)</span>
<span id="cb61-5"><a href="SPC.html#cb61-5"></a></span>
<span id="cb61-6"><a href="SPC.html#cb61-6"></a><span class="kw">dev.off</span>()</span></code></pre></div>
</div>
</div>
<div id="iterating-over-profiles-in-a-collection" class="section level2">
<h2><span class="header-section-number">2.11</span> Iterating Over Profiles in a Collection</h2>
<p>The <code>profileApply()</code> function is an extension of the familiar <em>apply()</em> family of functions that operate on vectors (<code>sapply</code> and <code>tapply</code>), matrices (<code>apply</code>), and lists (<code>lapply</code>)– extended to <code>SoilProfileCollection</code> objects. The function named in the <code>FUN</code> argument is evaluated once for each profile in the collection, typically returning a single value per profile. In this case, the ordering of the results would match the ordering of values in the site level attribute table.</p>
<div class="sourceCode" id="cb62"><pre class="sourceCode r codeBlock"><code class="sourceCode r"><span id="cb62-1"><a href="SPC.html#cb62-1"></a><span class="co"># max() returns the depth of a soil profile</span></span>
<span id="cb62-2"><a href="SPC.html#cb62-2"></a>sp4<span class="op">$</span>soil.depth &lt;-<span class="st"> </span><span class="kw">profileApply</span>(sp4, <span class="dt">FUN=</span>max)</span>
<span id="cb62-3"><a href="SPC.html#cb62-3"></a><span class="co"># max() with additional argument give max depth to non-missing &#39;clay&#39;</span></span>
<span id="cb62-4"><a href="SPC.html#cb62-4"></a>sp4<span class="op">$</span>soil.depth.clay &lt;-<span class="st"> </span><span class="kw">profileApply</span>(sp4, <span class="dt">FUN=</span>max, <span class="dt">v=</span><span class="st">&#39;clay&#39;</span>)</span>
<span id="cb62-5"><a href="SPC.html#cb62-5"></a><span class="co"># nrow() returns the number of horizons</span></span>
<span id="cb62-6"><a href="SPC.html#cb62-6"></a>sp4<span class="op">$</span>n.hz &lt;-<span class="st"> </span><span class="kw">profileApply</span>(sp4, <span class="dt">FUN=</span>nrow)</span>
<span id="cb62-7"><a href="SPC.html#cb62-7"></a><span class="co"># compute the mean clay content by profile using an inline function</span></span>
<span id="cb62-8"><a href="SPC.html#cb62-8"></a>sp4<span class="op">$</span>mean.clay &lt;-<span class="st"> </span><span class="kw">profileApply</span>(sp4, <span class="dt">FUN=</span><span class="cf">function</span>(i) <span class="kw">mean</span>(i<span class="op">$</span>clay))</span>
<span id="cb62-9"><a href="SPC.html#cb62-9"></a><span class="co"># estimate soil depth based on horizon designation</span></span>
<span id="cb62-10"><a href="SPC.html#cb62-10"></a>sp4<span class="op">$</span>soil.depth &lt;-<span class="st"> </span><span class="kw">profileApply</span>(sp4, estimateSoilDepth, <span class="dt">name=</span><span class="st">&#39;name&#39;</span>)</span></code></pre></div>
<p>When <code>FUN</code> returns a vector of the same length as the number of horizons in a profile, <code>profileApply()</code> can be used to create new horizon-level attributes. For example, the change in clay content with depth could be calculated via:</p>
<div class="sourceCode" id="cb63"><pre class="sourceCode r codeBlock"><code class="sourceCode r"><span id="cb63-1"><a href="SPC.html#cb63-1"></a><span class="co"># save as horizon-level attribute</span></span>
<span id="cb63-2"><a href="SPC.html#cb63-2"></a>sp4<span class="op">$</span>delta.clay &lt;-<span class="st"> </span><span class="kw">profileApply</span>(sp4, <span class="dt">FUN=</span><span class="cf">function</span>(i) <span class="kw">c</span>(<span class="ot">NA</span>, <span class="kw">diff</span>(i<span class="op">$</span>clay)))</span>
<span id="cb63-3"><a href="SPC.html#cb63-3"></a></span>
<span id="cb63-4"><a href="SPC.html#cb63-4"></a><span class="co"># check results:</span></span>
<span id="cb63-5"><a href="SPC.html#cb63-5"></a><span class="kw">horizons</span>(sp4)[<span class="dv">1</span><span class="op">:</span><span class="dv">6</span>, <span class="kw">c</span>(<span class="st">&#39;id&#39;</span>, <span class="st">&#39;top&#39;</span>, <span class="st">&#39;bottom&#39;</span>, <span class="st">&#39;clay&#39;</span>, <span class="st">&#39;delta.clay&#39;</span>)]</span></code></pre></div>
<pre class="outputBlock"><code>##       id top bottom clay delta.clay
## 1 colusa   0      3   21         NA
## 2 colusa   3      8   27          6
## 3 colusa   8     30   32          5
## 4 colusa  30     42   55         23
## 5  glenn   0      9   25         NA
## 6  glenn   9     34   34          9</code></pre>
<p>More complex summaries can be generated by writing a custom function that is then called by <code>profileApply()</code>. Note that each profile is passed into this function and accessed via a temporary variable (<code>i</code>), which is a <code>SoilProfileCollection</code> object containing a single profile. A list of <code>SoilProfileCollection</code> objects returned from a custom function can be re-constituted into a single <code>SoilProfileCollection</code> object via <code>combine</code>. See <code>help(profileApply)</code> for details.</p>
<div class="sourceCode" id="cb65"><pre class="sourceCode r codeBlock"><code class="sourceCode r"><span id="cb65-1"><a href="SPC.html#cb65-1"></a><span class="co"># compute hz-thickness weighted mean exchangeable-Ca:Mg</span></span>
<span id="cb65-2"><a href="SPC.html#cb65-2"></a>wt.mean.ca.mg &lt;-<span class="st"> </span><span class="cf">function</span>(i) {</span>
<span id="cb65-3"><a href="SPC.html#cb65-3"></a>    <span class="co"># use horizon thickness as a weight</span></span>
<span id="cb65-4"><a href="SPC.html#cb65-4"></a>    thick &lt;-<span class="st"> </span>i<span class="op">$</span>bottom <span class="op">-</span><span class="st"> </span>i<span class="op">$</span>top</span>
<span id="cb65-5"><a href="SPC.html#cb65-5"></a>    <span class="co"># compute the weighted mean, accounting for the possibility of missing data</span></span>
<span id="cb65-6"><a href="SPC.html#cb65-6"></a>    m &lt;-<span class="st"> </span><span class="kw">wtd.mean</span>(i<span class="op">$</span>ex_Ca_to_Mg, <span class="dt">weights=</span>thick, <span class="dt">na.rm=</span><span class="ot">TRUE</span>)</span>
<span id="cb65-7"><a href="SPC.html#cb65-7"></a>    <span class="kw">return</span>(m)</span>
<span id="cb65-8"><a href="SPC.html#cb65-8"></a>    }</span>
<span id="cb65-9"><a href="SPC.html#cb65-9"></a></span>
<span id="cb65-10"><a href="SPC.html#cb65-10"></a><span class="co"># apply our custom function and save results as a site-level attribute</span></span>
<span id="cb65-11"><a href="SPC.html#cb65-11"></a>sp4<span class="op">$</span>wt.mean.ca.to.mg &lt;-<span class="st"> </span><span class="kw">profileApply</span>(sp4, wt.mean.ca.mg)</span></code></pre></div>
<p>We can now use our some of our new site-level attributes to order the profiles when plotting. In this case profiles are ordered based on the horizon-thickness weighted mean, exchangeable Ca:Mg values. Horizons are colored by exchangeable Ca:Mg values.</p>
<div class="sourceCode" id="cb66"><pre class="sourceCode r codeBlock"><code class="sourceCode r"><span id="cb66-1"><a href="SPC.html#cb66-1"></a><span class="co"># the result is an index of rank</span></span>
<span id="cb66-2"><a href="SPC.html#cb66-2"></a>new.order &lt;-<span class="st"> </span><span class="kw">order</span>(sp4<span class="op">$</span>wt.mean.ca.to.mg)</span>
<span id="cb66-3"><a href="SPC.html#cb66-3"></a><span class="co"># plot the data using our new order based on Ca:Mg</span></span>
<span id="cb66-4"><a href="SPC.html#cb66-4"></a><span class="kw">par</span>(<span class="dt">mar=</span><span class="kw">c</span>(<span class="dv">4</span>,<span class="dv">0</span>,<span class="dv">3</span>,<span class="dv">0</span>)) <span class="co"># tighten figure margins</span></span>
<span id="cb66-5"><a href="SPC.html#cb66-5"></a><span class="kw">plotSPC</span>(sp4, <span class="dt">name=</span><span class="st">&#39;name&#39;</span>, <span class="dt">color=</span><span class="st">&#39;ex_Ca_to_Mg&#39;</span>, <span class="dt">plot.order=</span>new.order)</span>
<span id="cb66-6"><a href="SPC.html#cb66-6"></a><span class="co"># add an axis labeled with the sorting criteria</span></span>
<span id="cb66-7"><a href="SPC.html#cb66-7"></a><span class="kw">axis</span>(<span class="dv">1</span>, <span class="dt">at=</span><span class="dv">1</span><span class="op">:</span><span class="kw">length</span>(sp4), <span class="dt">labels=</span><span class="kw">round</span>(sp4<span class="op">$</span>wt.mean.ca.to.mg, <span class="dv">3</span>), <span class="dt">cex.axis=</span><span class="fl">0.75</span>)</span>
<span id="cb66-8"><a href="SPC.html#cb66-8"></a><span class="kw">mtext</span>(<span class="dv">1</span>, <span class="dt">line=</span><span class="fl">2.25</span>, <span class="dt">text=</span><span class="st">&#39;Horizon Thickness Weighted Mean Ex. Ca:Mg&#39;</span>, <span class="dt">cex=</span><span class="fl">0.75</span>)</span></code></pre></div>
<p><img src="aqpbook_files/figure-html/profileApply-4-1.png" style="display: block; margin: auto;" /></p>
</div>
<div id="slicing-soil-profile-collections" class="section level2">
<h2><span class="header-section-number">2.12</span> Slicing Soil Profile Collections</h2>
<p>Collections of soil profiles can be sliced (or re-sampled) into regular depth-intervals with the <code>slice()</code> function. The slicing structure and variables of interest are defined via formula notation:</p>
<div class="sourceCode" id="cb67"><pre class="sourceCode r codeBlock"><code class="sourceCode r"><span id="cb67-1"><a href="SPC.html#cb67-1"></a><span class="co"># slice select horizon-level attributes</span></span>
<span id="cb67-2"><a href="SPC.html#cb67-2"></a>seq <span class="op">~</span><span class="st"> </span>var<span class="fl">.1</span> <span class="op">+</span><span class="st"> </span>var<span class="fl">.2</span> <span class="op">+</span><span class="st"> </span>var<span class="fl">.3</span> <span class="op">+</span><span class="st"> </span>...</span>
<span id="cb67-3"><a href="SPC.html#cb67-3"></a><span class="co"># slice all horizon-level attributes</span></span>
<span id="cb67-4"><a href="SPC.html#cb67-4"></a>seq <span class="op">~</span><span class="st"> </span>.</span></code></pre></div>
<p>where <code>seq</code> is a sequence of integers (e.g. <code>0:15</code>, <code>c(5,10,15,20)</code>, etc.) and <code>var.1 + var.2 + var.3 + ...</code> are horizon-level attributes to slice. Both continuous and categorical variables can be named on the right-hand-side of the formula. The results returned by <code>slice()</code> is either a <code>SoilProfileCollection</code>, or <code>data.frame</code> when called with the optional argument <code>just.the.data=TRUE</code>. For example, to slice our sample data set into 1-cm intervals, from 0–15 cm:</p>
<div class="sourceCode" id="cb68"><pre class="sourceCode r codeBlock"><code class="sourceCode r"><span id="cb68-1"><a href="SPC.html#cb68-1"></a><span class="co"># slice data</span></span>
<span id="cb68-2"><a href="SPC.html#cb68-2"></a>sliced &lt;-<span class="st"> </span><span class="kw">slice</span>(sp4, <span class="dt">fm=</span> <span class="dv">0</span><span class="op">:</span><span class="dv">15</span> <span class="op">~</span><span class="st"> </span>sand <span class="op">+</span><span class="st"> </span>silt <span class="op">+</span><span class="st"> </span>clay <span class="op">+</span><span class="st"> </span>name <span class="op">+</span><span class="st"> </span>ex_Ca_to_Mg)</span>
<span id="cb68-3"><a href="SPC.html#cb68-3"></a><span class="co"># check the result</span></span>
<span id="cb68-4"><a href="SPC.html#cb68-4"></a><span class="kw">class</span>(sliced)</span></code></pre></div>
<pre class="outputBlock"><code>## [1] &quot;SoilProfileCollection&quot;
## attr(,&quot;package&quot;)
## [1] &quot;aqp&quot;</code></pre>
<div class="sourceCode" id="cb70"><pre class="sourceCode r codeBlock"><code class="sourceCode r"><span id="cb70-1"><a href="SPC.html#cb70-1"></a><span class="co"># plot sliced data</span></span>
<span id="cb70-2"><a href="SPC.html#cb70-2"></a><span class="kw">par</span>(<span class="dt">mar=</span><span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">3</span>,<span class="dv">0</span>)) <span class="co"># tighten figure margins</span></span>
<span id="cb70-3"><a href="SPC.html#cb70-3"></a><span class="kw">plotSPC</span>(sliced, <span class="dt">name=</span><span class="st">&#39;name&#39;</span>, <span class="dt">color=</span><span class="st">&#39;ex_Ca_to_Mg&#39;</span>)</span></code></pre></div>
<p><img src="aqpbook_files/figure-html/unnamed-chunk-34-1.png" style="display: block; margin: auto;" /></p>
<p>Once soil profile data have been sliced, it is simple to extract “chunks” of data by depth interval via <code>[</code>-subsetting:</p>
<div class="sourceCode" id="cb71"><pre class="sourceCode r codeBlock"><code class="sourceCode r"><span id="cb71-1"><a href="SPC.html#cb71-1"></a><span class="co"># slice from 0 to max depth in the collection</span></span>
<span id="cb71-2"><a href="SPC.html#cb71-2"></a>sliced &lt;-<span class="st"> </span><span class="kw">slice</span>(sp4, <span class="dt">fm=</span> <span class="dv">0</span><span class="op">:</span><span class="kw">max</span>(sp4) <span class="op">~</span><span class="st"> </span>sand <span class="op">+</span><span class="st"> </span>silt <span class="op">+</span><span class="st"> </span>clay <span class="op">+</span><span class="st"> </span>name <span class="op">+</span><span class="st"> </span>ex_Ca_to_Mg)</span>
<span id="cb71-3"><a href="SPC.html#cb71-3"></a><span class="co"># extract all data over the range of 5--10 cm:</span></span>
<span id="cb71-4"><a href="SPC.html#cb71-4"></a><span class="kw">plotSPC</span>(sliced[, <span class="dv">5</span><span class="op">:</span><span class="dv">10</span>])</span>
<span id="cb71-5"><a href="SPC.html#cb71-5"></a><span class="co"># extract all data over the range of 25--50 cm:</span></span>
<span id="cb71-6"><a href="SPC.html#cb71-6"></a><span class="kw">plotSPC</span>(sliced[, <span class="dv">25</span><span class="op">:</span><span class="dv">50</span>])</span>
<span id="cb71-7"><a href="SPC.html#cb71-7"></a><span class="co"># extract all data over the range of 10--20 and 40--50 cm:</span></span>
<span id="cb71-8"><a href="SPC.html#cb71-8"></a><span class="kw">plotSPC</span>(sliced[, <span class="kw">c</span>(<span class="dv">10</span><span class="op">:</span><span class="dv">20</span>, <span class="dv">40</span><span class="op">:</span><span class="dv">50</span>)])</span></code></pre></div>
</div>
<div id="ragged-selection-glom" class="section level2">
<h2><span class="header-section-number">2.13</span> Ragged Selection: <code>glom</code></h2>
<p>Select all horizons that overlap the interval of 5-15cm.</p>
<div class="sourceCode" id="cb72"><pre class="sourceCode r codeBlock"><code class="sourceCode r"><span id="cb72-1"><a href="SPC.html#cb72-1"></a><span class="co"># truncate to the interval 0-15cm</span></span>
<span id="cb72-2"><a href="SPC.html#cb72-2"></a>clods &lt;-<span class="st"> </span><span class="kw">profileApply</span>(sp4, glom, <span class="dt">z1 =</span> <span class="dv">5</span>, <span class="dt">z2 =</span> <span class="dv">15</span>)</span>
<span id="cb72-3"><a href="SPC.html#cb72-3"></a>clods &lt;-<span class="st"> </span><span class="kw">combine</span>(clods)</span>
<span id="cb72-4"><a href="SPC.html#cb72-4"></a><span class="co"># check</span></span>
<span id="cb72-5"><a href="SPC.html#cb72-5"></a><span class="kw">par</span>(<span class="dt">mar=</span><span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">3</span>,<span class="dv">0</span>)) <span class="co"># tighten figure margins</span></span>
<span id="cb72-6"><a href="SPC.html#cb72-6"></a><span class="kw">plotSPC</span>(clods, <span class="dt">name=</span><span class="st">&#39;name&#39;</span>, <span class="dt">color=</span><span class="st">&#39;ex_Ca_to_Mg&#39;</span>)</span>
<span id="cb72-7"><a href="SPC.html#cb72-7"></a></span>
<span id="cb72-8"><a href="SPC.html#cb72-8"></a><span class="kw">rect</span>(<span class="dt">xleft =</span> <span class="fl">0.5</span>, <span class="dt">ybottom =</span> <span class="dv">15</span>, <span class="dt">xright =</span> <span class="kw">length</span>(sp4) <span class="op">+</span><span class="st"> </span><span class="fl">0.5</span>, <span class="dt">ytop =</span> <span class="dv">0</span>)</span></code></pre></div>
<p><img src="aqpbook_files/figure-html/unnamed-chunk-36-1.png" style="display: block; margin: auto;" /></p>
<div id="truncation-trunc" class="section level3">
<h3><span class="header-section-number">2.13.1</span> Truncation: <code>trunc</code></h3>
<p>Truncate the SPC to the interval of 5-15cm.</p>
<div class="sourceCode" id="cb73"><pre class="sourceCode r codeBlock"><code class="sourceCode r"><span id="cb73-1"><a href="SPC.html#cb73-1"></a><span class="co"># truncate to the interval 0-15cm</span></span>
<span id="cb73-2"><a href="SPC.html#cb73-2"></a>sp4.truncated &lt;-<span class="st"> </span><span class="kw">trunc</span>(sp4, <span class="dv">0</span>, <span class="dv">15</span>)</span>
<span id="cb73-3"><a href="SPC.html#cb73-3"></a><span class="co"># check</span></span>
<span id="cb73-4"><a href="SPC.html#cb73-4"></a><span class="kw">par</span>(<span class="dt">mar=</span><span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">3</span>,<span class="dv">0</span>)) <span class="co"># tighten figure margins</span></span>
<span id="cb73-5"><a href="SPC.html#cb73-5"></a><span class="kw">plotSPC</span>(sp4.truncated, <span class="dt">name=</span><span class="st">&#39;name&#39;</span>, <span class="dt">color=</span><span class="st">&#39;ex_Ca_to_Mg&#39;</span>)</span></code></pre></div>
<p><img src="aqpbook_files/figure-html/unnamed-chunk-37-1.png" style="display: block; margin: auto;" /></p>
</div>
</div>
<div id="aggregating-soil-profile-collections-along-regular-slabs" class="section level2">
<h2><span class="header-section-number">2.14</span> Aggregating Soil Profile Collections Along Regular “Slabs”</h2>
<p>Depth-wise summary of horizon-level attributes is performed with the <code>slab()</code> function. Profile grouping criteria and horizon attribute selection is parametrized via formula: either <code>groups ~ var1 + var2 + var3</code> where named variables are aggregated within <code>groups</code> OR where named variables are aggregated across the entire collection <code>~ var1 + var2 + var3</code>. The default summary function (<code>slab.fun</code>) computes the 5th, 25th, 50th, 75th, and 95th percentiles via Harrell-Davis quantile estimator.</p>
<p>The depth structure (“slabs”) over which summaries are computed is defined with the <code>slab.structure</code> argument using:</p>
<ul>
<li>a single integer (e.g. <code>10</code>): data are aggregated over a regular sequence of 10-unit thickness slabs</li>
<li>a vector of 2 integers (e.g. <code>c(50, 60)</code>): data are aggregated over depths spanning 50–60 units</li>
<li>a vector of 3 or more integers (e.g. <code>c(0, 5, 10, 50, 100)</code>): data are aggregated over the depths spanning 0–5, 5–10, 10–50, 50–100 units</li>
</ul>
<div class="sourceCode" id="cb74"><pre class="sourceCode r codeBlock"><code class="sourceCode r"><span id="cb74-1"><a href="SPC.html#cb74-1"></a><span class="co"># aggregate a couple of the horizon-level attributes, </span></span>
<span id="cb74-2"><a href="SPC.html#cb74-2"></a><span class="co"># across the entire collection, </span></span>
<span id="cb74-3"><a href="SPC.html#cb74-3"></a><span class="co"># from 0--10 cm</span></span>
<span id="cb74-4"><a href="SPC.html#cb74-4"></a><span class="co"># computing the mean value ignoring missing data</span></span>
<span id="cb74-5"><a href="SPC.html#cb74-5"></a><span class="kw">slab</span>(sp4, <span class="dt">fm=</span> <span class="op">~</span><span class="st"> </span>sand <span class="op">+</span><span class="st"> </span>silt <span class="op">+</span><span class="st"> </span>clay, <span class="dt">slab.structure=</span><span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">10</span>), <span class="dt">slab.fun=</span>mean, <span class="dt">na.rm=</span><span class="ot">TRUE</span>)</span></code></pre></div>
<pre class="outputBlock"><code>##   variable all.profiles value top bottom contributing_fraction
## 1     sand            1 47.63   0     10                     1
## 2     silt            1 31.15   0     10                     1
## 3     clay            1 21.11   0     10                     1</code></pre>
<div class="sourceCode" id="cb76"><pre class="sourceCode r codeBlock"><code class="sourceCode r"><span id="cb76-1"><a href="SPC.html#cb76-1"></a><span class="co"># again, this time within groups defined by a site-level attribute:</span></span>
<span id="cb76-2"><a href="SPC.html#cb76-2"></a><span class="kw">slab</span>(sp4, <span class="dt">fm=</span> group <span class="op">~</span><span class="st"> </span>sand <span class="op">+</span><span class="st"> </span>silt <span class="op">+</span><span class="st"> </span>clay, <span class="dt">slab.structure=</span><span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">10</span>), <span class="dt">slab.fun=</span>mean, <span class="dt">na.rm=</span><span class="ot">TRUE</span>)</span></code></pre></div>
<pre class="outputBlock"><code>##   variable group value top bottom contributing_fraction
## 1     sand     A 48.26   0     10                     1
## 2     silt     A 31.52   0     10                     1
## 3     clay     A 20.30   0     10                     1
## 4     sand     B 47.00   0     10                     1
## 5     silt     B 30.78   0     10                     1
## 6     clay     B 21.92   0     10                     1</code></pre>
<div class="sourceCode" id="cb78"><pre class="sourceCode r codeBlock"><code class="sourceCode r"><span id="cb78-1"><a href="SPC.html#cb78-1"></a><span class="co"># again, this time over several depth ranges</span></span>
<span id="cb78-2"><a href="SPC.html#cb78-2"></a><span class="kw">slab</span>(sp4, <span class="dt">fm=</span> <span class="op">~</span><span class="st"> </span>sand <span class="op">+</span><span class="st"> </span>silt <span class="op">+</span><span class="st"> </span>clay, <span class="dt">slab.structure=</span><span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">10</span>,<span class="dv">25</span>,<span class="dv">40</span>), <span class="dt">slab.fun=</span>mean, <span class="dt">na.rm=</span><span class="ot">TRUE</span>)</span></code></pre></div>
<pre class="outputBlock"><code>##   variable all.profiles    value top bottom contributing_fraction
## 1     sand            1 47.63000   0     10             1.0000000
## 2     sand            1 42.38931  10     25             0.8733333
## 3     sand            1 32.14607  25     40             0.5933333
## 4     silt            1 31.15000   0     10             1.0000000
## 5     silt            1 29.41221  10     25             0.8733333
## 6     silt            1 31.34831  25     40             0.5933333
## 7     clay            1 21.11000   0     10             1.0000000
## 8     clay            1 28.10687  10     25             0.8733333
## 9     clay            1 36.26966  25     40             0.5933333</code></pre>
<div class="sourceCode" id="cb80"><pre class="sourceCode r codeBlock"><code class="sourceCode r"><span id="cb80-1"><a href="SPC.html#cb80-1"></a><span class="co"># again, this time along 1-cm slices, computing quantiles</span></span>
<span id="cb80-2"><a href="SPC.html#cb80-2"></a>agg &lt;-<span class="st"> </span><span class="kw">slab</span>(sp4, <span class="dt">fm=</span> <span class="op">~</span><span class="st"> </span>Mg <span class="op">+</span><span class="st"> </span>Ca <span class="op">+</span><span class="st"> </span>ex_Ca_to_Mg <span class="op">+</span><span class="st"> </span>CEC_<span class="dv">7</span> <span class="op">+</span><span class="st"> </span>clay)</span>
<span id="cb80-3"><a href="SPC.html#cb80-3"></a></span>
<span id="cb80-4"><a href="SPC.html#cb80-4"></a><span class="co"># see ?slab for details on the default aggregate function</span></span>
<span id="cb80-5"><a href="SPC.html#cb80-5"></a><span class="kw">head</span>(agg)</span></code></pre></div>
<pre class="outputBlock"><code>##   variable all.profiles  p.q5  p.q25 p.q50  p.q75 p.q95 top bottom contributing_fraction
## 1       Mg            1 6.015 12.175 14.60 21.125 27.13   0      1                     1
## 2       Mg            1 6.015 12.175 14.60 21.125 27.13   1      2                     1
## 3       Mg            1 6.015 12.175 19.15 25.650 27.76   2      3                     1
## 4       Mg            1 6.195 13.175 21.05 25.050 30.73   3      4                     1
## 5       Mg            1 6.195 13.175 21.05 25.050 30.73   4      5                     1
## 6       Mg            1 6.195 13.175 21.05 26.250 31.72   5      6                     1</code></pre>
<div class="sourceCode" id="cb82"><pre class="sourceCode r codeBlock"><code class="sourceCode r"><span id="cb82-1"><a href="SPC.html#cb82-1"></a><span class="co"># plot median +/i bounds defined by the 25th and 75th percentiles</span></span>
<span id="cb82-2"><a href="SPC.html#cb82-2"></a><span class="co"># this is lattice graphics, syntax is a little rough</span></span>
<span id="cb82-3"><a href="SPC.html#cb82-3"></a><span class="kw">xyplot</span>(top <span class="op">~</span><span class="st"> </span>p.q50 <span class="op">|</span><span class="st"> </span>variable, <span class="dt">data=</span>agg, <span class="dt">ylab=</span><span class="st">&#39;Depth&#39;</span>,</span>
<span id="cb82-4"><a href="SPC.html#cb82-4"></a>             <span class="dt">xlab=</span><span class="st">&#39;median bounded by 25th and 75th percentiles&#39;</span>,</span>
<span id="cb82-5"><a href="SPC.html#cb82-5"></a>             <span class="dt">lower=</span>agg<span class="op">$</span>p.q25, <span class="dt">upper=</span>agg<span class="op">$</span>p.q75, <span class="dt">ylim=</span><span class="kw">c</span>(<span class="dv">42</span>,<span class="op">-</span><span class="dv">2</span>),</span>
<span id="cb82-6"><a href="SPC.html#cb82-6"></a>             <span class="dt">panel=</span>panel.depth_function,</span>
<span id="cb82-7"><a href="SPC.html#cb82-7"></a>             <span class="dt">alpha=</span><span class="fl">0.25</span>, <span class="dt">sync.colors=</span><span class="ot">TRUE</span>,</span>
<span id="cb82-8"><a href="SPC.html#cb82-8"></a>             <span class="dt">par.settings=</span><span class="kw">list</span>(<span class="dt">superpose.line=</span><span class="kw">list</span>(<span class="dt">col=</span><span class="st">&#39;RoyalBlue&#39;</span>, <span class="dt">lwd=</span><span class="dv">2</span>)),</span>
<span id="cb82-9"><a href="SPC.html#cb82-9"></a>             <span class="dt">prepanel=</span>prepanel.depth_function,</span>
<span id="cb82-10"><a href="SPC.html#cb82-10"></a>             <span class="dt">cf=</span>agg<span class="op">$</span>contributing_fraction, <span class="dt">cf.col=</span><span class="st">&#39;black&#39;</span>, <span class="dt">cf.interval=</span><span class="dv">5</span>, </span>
<span id="cb82-11"><a href="SPC.html#cb82-11"></a>             <span class="dt">layout=</span><span class="kw">c</span>(<span class="dv">5</span>,<span class="dv">1</span>), <span class="dt">strip=</span><span class="kw">strip.custom</span>(<span class="dt">bg=</span><span class="kw">grey</span>(<span class="fl">0.8</span>)),</span>
<span id="cb82-12"><a href="SPC.html#cb82-12"></a>             <span class="dt">scales=</span><span class="kw">list</span>(<span class="dt">x=</span><span class="kw">list</span>(<span class="dt">tick.number=</span><span class="dv">4</span>, <span class="dt">alternating=</span><span class="dv">3</span>, <span class="dt">relation=</span><span class="st">&#39;free&#39;</span>))</span>
<span id="cb82-13"><a href="SPC.html#cb82-13"></a>             )</span></code></pre></div>
<p><img src="aqpbook_files/figure-html/slab-1.png" style="display: block; margin: auto;" /></p>
<p>Depth-wise aggregation can be useful for visual evaluation of multivariate similarity among groups of profiles.</p>
<div class="sourceCode" id="cb83"><pre class="sourceCode r codeBlock"><code class="sourceCode r"><span id="cb83-1"><a href="SPC.html#cb83-1"></a><span class="co"># processing the &quot;napa&quot; and tehama profiles</span></span>
<span id="cb83-2"><a href="SPC.html#cb83-2"></a>idx &lt;-<span class="st"> </span><span class="kw">which</span>(<span class="kw">profile_id</span>(sp4) <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&#39;napa&#39;</span>, <span class="st">&#39;tehama&#39;</span>))</span>
<span id="cb83-3"><a href="SPC.html#cb83-3"></a>napa.and.tehama &lt;-<span class="st"> </span><span class="kw">slab</span>(sp4[idx, ], <span class="dt">fm=</span> <span class="op">~</span><span class="st"> </span>Mg <span class="op">+</span><span class="st"> </span>Ca <span class="op">+</span><span class="st"> </span>ex_Ca_to_Mg <span class="op">+</span><span class="st"> </span>CEC_<span class="dv">7</span> <span class="op">+</span><span class="st"> </span>clay)</span>
<span id="cb83-4"><a href="SPC.html#cb83-4"></a></span>
<span id="cb83-5"><a href="SPC.html#cb83-5"></a><span class="co"># combine with the collection-wide aggregate data</span></span>
<span id="cb83-6"><a href="SPC.html#cb83-6"></a>g &lt;-<span class="st"> </span><span class="kw">make.groups</span>(<span class="dt">collection=</span>agg, <span class="dt">napa.and.tehama=</span>napa.and.tehama)</span>
<span id="cb83-7"><a href="SPC.html#cb83-7"></a></span>
<span id="cb83-8"><a href="SPC.html#cb83-8"></a><span class="co"># compare graphically:</span></span>
<span id="cb83-9"><a href="SPC.html#cb83-9"></a><span class="kw">xyplot</span>(top <span class="op">~</span><span class="st"> </span>p.q50 <span class="op">|</span><span class="st"> </span>variable, <span class="dt">groups=</span>which, <span class="dt">data=</span>g, <span class="dt">ylab=</span><span class="st">&#39;Depth&#39;</span>,</span>
<span id="cb83-10"><a href="SPC.html#cb83-10"></a>             <span class="dt">xlab=</span><span class="st">&#39;median bounded by 25th and 75th percentiles&#39;</span>,</span>
<span id="cb83-11"><a href="SPC.html#cb83-11"></a>             <span class="dt">lower=</span>g<span class="op">$</span>p.q25, <span class="dt">upper=</span>g<span class="op">$</span>p.q75, <span class="dt">ylim=</span><span class="kw">c</span>(<span class="dv">42</span>,<span class="op">-</span><span class="dv">2</span>),</span>
<span id="cb83-12"><a href="SPC.html#cb83-12"></a>             <span class="dt">panel=</span>panel.depth_function,</span>
<span id="cb83-13"><a href="SPC.html#cb83-13"></a>             <span class="dt">alpha=</span><span class="fl">0.25</span>, <span class="dt">sync.colors=</span><span class="ot">TRUE</span>, <span class="dt">cf=</span>g<span class="op">$</span>contributing_fraction, <span class="dt">cf.interval=</span><span class="dv">10</span>, </span>
<span id="cb83-14"><a href="SPC.html#cb83-14"></a>             <span class="dt">par.settings=</span><span class="kw">list</span>(<span class="dt">superpose.line=</span><span class="kw">list</span>(<span class="dt">col=</span><span class="kw">c</span>(<span class="st">&#39;RoyalBlue&#39;</span>, <span class="st">&#39;Red4&#39;</span>), <span class="dt">lwd=</span><span class="dv">2</span>, <span class="dt">lty=</span><span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">2</span>))),</span>
<span id="cb83-15"><a href="SPC.html#cb83-15"></a>             <span class="dt">prepanel=</span>prepanel.depth_function,</span>
<span id="cb83-16"><a href="SPC.html#cb83-16"></a>             <span class="dt">layout=</span><span class="kw">c</span>(<span class="dv">5</span>,<span class="dv">1</span>), <span class="dt">strip=</span><span class="kw">strip.custom</span>(<span class="dt">bg=</span><span class="kw">grey</span>(<span class="fl">0.8</span>)),</span>
<span id="cb83-17"><a href="SPC.html#cb83-17"></a>             <span class="dt">scales=</span><span class="kw">list</span>(<span class="dt">x=</span><span class="kw">list</span>(<span class="dt">tick.number=</span><span class="dv">4</span>, <span class="dt">alternating=</span><span class="dv">3</span>, <span class="dt">relation=</span><span class="st">&#39;free&#39;</span>)),</span>
<span id="cb83-18"><a href="SPC.html#cb83-18"></a>             <span class="dt">auto.key=</span><span class="kw">list</span>(<span class="dt">columns=</span><span class="dv">2</span>, <span class="dt">lines=</span><span class="ot">TRUE</span>, <span class="dt">points=</span><span class="ot">FALSE</span>)</span>
<span id="cb83-19"><a href="SPC.html#cb83-19"></a>             )</span></code></pre></div>
<p><img src="aqpbook_files/figure-html/slab-2-1.png" style="display: block; margin: auto;" /></p>
<div id="change-of-support-re-alignment-of-horizon-depths-via-aggregation" class="section level3">
<h3><span class="header-section-number">2.14.1</span> Change of Support: re-alignment of horizon depths via aggregation</h3>
<p>Occasionally there is a need for converting data associated with soil horizons, as described in the field, to a new set of depth intervals. This kind of <em>change of support</em> operation requires some form of aggregation (mean, median, etc.) and possibly interpolation (e.g. splines). The <code>slab</code> function is the simplest way to implement a change of depth support via aggregation. The following example is based on a set of 9 randomly generated profiles, re-aligned to the Global Soil Map (GSM) standard depths.</p>
<div class="sourceCode" id="cb84"><pre class="sourceCode r codeBlock"><code class="sourceCode r"><span id="cb84-1"><a href="SPC.html#cb84-1"></a><span class="kw">library</span>(reshape2)</span>
<span id="cb84-2"><a href="SPC.html#cb84-2"></a><span class="kw">library</span>(RColorBrewer)</span>
<span id="cb84-3"><a href="SPC.html#cb84-3"></a></span>
<span id="cb84-4"><a href="SPC.html#cb84-4"></a><span class="co"># 9 random profiles</span></span>
<span id="cb84-5"><a href="SPC.html#cb84-5"></a><span class="co"># 1 simulated properties via logistic power peak (LPP) function</span></span>
<span id="cb84-6"><a href="SPC.html#cb84-6"></a><span class="co"># 6, 7, or 8 horizons per profile</span></span>
<span id="cb84-7"><a href="SPC.html#cb84-7"></a><span class="co"># result is a list of single-profile SPC</span></span>
<span id="cb84-8"><a href="SPC.html#cb84-8"></a>d &lt;-<span class="st"> </span><span class="kw">lapply</span>(</span>
<span id="cb84-9"><a href="SPC.html#cb84-9"></a>  <span class="kw">as.character</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">9</span>), </span>
<span id="cb84-10"><a href="SPC.html#cb84-10"></a>  random_profile, </span>
<span id="cb84-11"><a href="SPC.html#cb84-11"></a>  <span class="dt">n =</span> <span class="kw">c</span>(<span class="dv">6</span>, <span class="dv">7</span>, <span class="dv">8</span>), </span>
<span id="cb84-12"><a href="SPC.html#cb84-12"></a>  <span class="dt">n_prop =</span> <span class="dv">1</span>, </span>
<span id="cb84-13"><a href="SPC.html#cb84-13"></a>  <span class="dt">method =</span> <span class="st">&#39;LPP&#39;</span>,</span>
<span id="cb84-14"><a href="SPC.html#cb84-14"></a>  <span class="dt">SPC =</span> <span class="ot">TRUE</span></span>
<span id="cb84-15"><a href="SPC.html#cb84-15"></a>)</span>
<span id="cb84-16"><a href="SPC.html#cb84-16"></a></span>
<span id="cb84-17"><a href="SPC.html#cb84-17"></a><span class="co"># combine into single SPC</span></span>
<span id="cb84-18"><a href="SPC.html#cb84-18"></a>d &lt;-<span class="st"> </span><span class="kw">combine</span>(d)</span>
<span id="cb84-19"><a href="SPC.html#cb84-19"></a></span>
<span id="cb84-20"><a href="SPC.html#cb84-20"></a><span class="co"># GSM depths</span></span>
<span id="cb84-21"><a href="SPC.html#cb84-21"></a>gsm.depths &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">5</span>, <span class="dv">15</span>, <span class="dv">30</span>, <span class="dv">60</span>, <span class="dv">100</span>, <span class="dv">200</span>)</span>
<span id="cb84-22"><a href="SPC.html#cb84-22"></a></span>
<span id="cb84-23"><a href="SPC.html#cb84-23"></a><span class="co"># aggregate using mean: wt.mean within slabs</span></span>
<span id="cb84-24"><a href="SPC.html#cb84-24"></a><span class="co"># see ?slab for ideas on how to parameterize slab.fun</span></span>
<span id="cb84-25"><a href="SPC.html#cb84-25"></a>d.gsm &lt;-<span class="st"> </span><span class="kw">slab</span>(d, <span class="dt">fm=</span>id <span class="op">~</span><span class="st"> </span>p1, <span class="dt">slab.structure =</span> gsm.depths, <span class="dt">slab.fun =</span> mean, <span class="dt">na.rm=</span><span class="ot">TRUE</span>)</span>
<span id="cb84-26"><a href="SPC.html#cb84-26"></a></span>
<span id="cb84-27"><a href="SPC.html#cb84-27"></a><span class="co"># note: result is in long-format</span></span>
<span id="cb84-28"><a href="SPC.html#cb84-28"></a><span class="co"># note: horizon names are lost due to aggregation</span></span>
<span id="cb84-29"><a href="SPC.html#cb84-29"></a><span class="kw">head</span>(d.gsm, <span class="dv">7</span>)</span></code></pre></div>
<pre class="outputBlock"><code>##   variable id    value top bottom contributing_fraction
## 1       p1  1 48.63430   0      5                1.0000
## 2       p1  1 48.63430   5     15                1.0000
## 3       p1  1 54.89213  15     30                1.0000
## 4       p1  1 51.68713  30     60                1.0000
## 5       p1  1 43.65356  60    100                1.0000
## 6       p1  1 36.60044 100    200                0.5375
## 7       p1  2 16.88935   0      5                1.0000</code></pre>
<p>A simple graphical comparison of the original and re-aligned soil profile data.</p>
<div class="sourceCode" id="cb86"><pre class="sourceCode r codeBlock"><code class="sourceCode r"><span id="cb86-1"><a href="SPC.html#cb86-1"></a><span class="co"># reshape to wide format</span></span>
<span id="cb86-2"><a href="SPC.html#cb86-2"></a><span class="co"># this scales to &gt; 1 aggregated variables</span></span>
<span id="cb86-3"><a href="SPC.html#cb86-3"></a>d.gsm.pedons &lt;-<span class="st"> </span><span class="kw">dcast</span>(d.gsm, id <span class="op">+</span><span class="st"> </span>top <span class="op">+</span><span class="st"> </span>bottom <span class="op">~</span><span class="st"> </span>variable, <span class="dt">value.var =</span> <span class="st">&#39;value&#39;</span>)</span>
<span id="cb86-4"><a href="SPC.html#cb86-4"></a><span class="kw">depths</span>(d.gsm.pedons) &lt;-<span class="st"> </span>id <span class="op">~</span><span class="st"> </span>top <span class="op">+</span><span class="st"> </span>bottom</span>
<span id="cb86-5"><a href="SPC.html#cb86-5"></a></span>
<span id="cb86-6"><a href="SPC.html#cb86-6"></a><span class="co"># iterate over aggregated profiles and make new hz names</span></span>
<span id="cb86-7"><a href="SPC.html#cb86-7"></a>d.gsm.pedons<span class="op">$</span>hzname &lt;-<span class="st"> </span><span class="kw">profileApply</span>(d.gsm.pedons, <span class="cf">function</span>(i) {<span class="kw">paste0</span>(<span class="st">&#39;GSM-&#39;</span>, <span class="dv">1</span><span class="op">:</span><span class="kw">nrow</span>(i))})</span>
<span id="cb86-8"><a href="SPC.html#cb86-8"></a></span>
<span id="cb86-9"><a href="SPC.html#cb86-9"></a><span class="co"># compare original and aggregated</span></span>
<span id="cb86-10"><a href="SPC.html#cb86-10"></a><span class="kw">par</span>(<span class="dt">mar=</span><span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">3</span>,<span class="dv">3</span>), <span class="dt">mfrow=</span><span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">1</span>))</span>
<span id="cb86-11"><a href="SPC.html#cb86-11"></a><span class="kw">plotSPC</span>(d, <span class="dt">color=</span><span class="st">&#39;p1&#39;</span>)</span>
<span id="cb86-12"><a href="SPC.html#cb86-12"></a><span class="kw">plotSPC</span>(d.gsm.pedons, <span class="dt">color=</span><span class="st">&#39;p1&#39;</span>)</span></code></pre></div>
<p><img src="aqpbook_files/figure-html/unnamed-chunk-39-1.png" style="display: block; margin: auto;" /></p>
<p>Note that re-aligned data may not represent reality (and should therefore be used with caution) when the original soil depth is shallower than the deepest of the new (re-aligned) horizon depths. The <code>contributing_fraction</code> metric returned by <code>slab()</code> can be useful for assessing how much <em>real</em> data were used to generate the new set of re-aligned data.</p>
<div class="sourceCode" id="cb87"><pre class="sourceCode r codeBlock"><code class="sourceCode r"><span id="cb87-1"><a href="SPC.html#cb87-1"></a><span class="co"># reshape to wide format</span></span>
<span id="cb87-2"><a href="SPC.html#cb87-2"></a>d.gsm.pedons<span class="fl">.2</span> &lt;-<span class="st"> </span><span class="kw">dcast</span>(d.gsm, id <span class="op">+</span><span class="st"> </span>top <span class="op">+</span><span class="st"> </span>bottom <span class="op">~</span><span class="st"> </span>variable, <span class="dt">value.var =</span> <span class="st">&#39;contributing_fraction&#39;</span>)</span>
<span id="cb87-3"><a href="SPC.html#cb87-3"></a><span class="kw">depths</span>(d.gsm.pedons<span class="fl">.2</span>) &lt;-<span class="st"> </span>id <span class="op">~</span><span class="st"> </span>top <span class="op">+</span><span class="st"> </span>bottom</span>
<span id="cb87-4"><a href="SPC.html#cb87-4"></a></span>
<span id="cb87-5"><a href="SPC.html#cb87-5"></a><span class="co"># compare original and aggregated</span></span>
<span id="cb87-6"><a href="SPC.html#cb87-6"></a><span class="kw">par</span>(<span class="dt">mar=</span><span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">3</span>,<span class="dv">3</span>), <span class="dt">mfrow=</span><span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">1</span>))</span>
<span id="cb87-7"><a href="SPC.html#cb87-7"></a><span class="kw">plotSPC</span>(d.gsm.pedons, <span class="dt">name=</span><span class="st">&#39;&#39;</span>, <span class="dt">color=</span><span class="st">&#39;p1&#39;</span>)</span>
<span id="cb87-8"><a href="SPC.html#cb87-8"></a><span class="kw">plotSPC</span>(d.gsm.pedons<span class="fl">.2</span>, <span class="dt">name=</span><span class="st">&#39;&#39;</span>, <span class="dt">color=</span><span class="st">&#39;p1&#39;</span>, <span class="dt">col.label=</span><span class="st">&#39;Contributing Fraction&#39;</span>, <span class="dt">col.palette=</span><span class="kw">brewer.pal</span>(<span class="dv">10</span>, <span class="st">&#39;Spectral&#39;</span>))</span></code></pre></div>
<p><img src="aqpbook_files/figure-html/unnamed-chunk-40-1.png" style="display: block; margin: auto;" /></p>
</div>
</div>
<div id="pair-wise-dissimilarity" class="section level2">
<h2><span class="header-section-number">2.15</span> Pair-Wise Dissimilarity</h2>
<p>Calculation of between-profile dissimilarity is performed using the <code>profile_compare()</code> function. Dissimilarity values depend on attributes selection (e.g. clay, CEC, pH , etc.), optional depth-weighting parameter (<code>k</code>), and a maximum depth of evaluation (<code>max_d</code>). This topic is further documented in a <a href="http://ncss-tech.github.io/AQP/aqp/aqp-profile-dissimilarity.html">related tutorial</a>, the function manual page (type <code>help(profile_compare)</code> in the <strong>R</strong> console), and <a href="http://dx.doi.org/10.1016/j.cageo.2012.10.020">this paper</a>.</p>
<div class="sourceCode" id="cb88"><pre class="sourceCode r codeBlock"><code class="sourceCode r"><span id="cb88-1"><a href="SPC.html#cb88-1"></a><span class="kw">library</span>(cluster)</span>
<span id="cb88-2"><a href="SPC.html#cb88-2"></a><span class="kw">library</span>(sharpshootR)</span>
<span id="cb88-3"><a href="SPC.html#cb88-3"></a></span>
<span id="cb88-4"><a href="SPC.html#cb88-4"></a><span class="co"># start fresh</span></span>
<span id="cb88-5"><a href="SPC.html#cb88-5"></a><span class="kw">data</span>(sp4)</span>
<span id="cb88-6"><a href="SPC.html#cb88-6"></a><span class="kw">depths</span>(sp4) &lt;-<span class="st"> </span>id <span class="op">~</span><span class="st"> </span>top <span class="op">+</span><span class="st"> </span>bottom</span>
<span id="cb88-7"><a href="SPC.html#cb88-7"></a></span>
<span id="cb88-8"><a href="SPC.html#cb88-8"></a><span class="co"># eval dissimilarity:</span></span>
<span id="cb88-9"><a href="SPC.html#cb88-9"></a><span class="co"># using Ex-Ca:Mg and CEC at pH 7</span></span>
<span id="cb88-10"><a href="SPC.html#cb88-10"></a><span class="co"># with no depth-weighting (k=0)</span></span>
<span id="cb88-11"><a href="SPC.html#cb88-11"></a><span class="co"># to a maximum depth of 40 cm</span></span>
<span id="cb88-12"><a href="SPC.html#cb88-12"></a>d &lt;-<span class="st"> </span><span class="kw">profile_compare</span>(sp4, <span class="dt">vars=</span><span class="kw">c</span>(<span class="st">&#39;ex_Ca_to_Mg&#39;</span>, <span class="st">&#39;CEC_7&#39;</span>), <span class="dt">k=</span><span class="dv">0</span>, <span class="dt">max_d=</span><span class="dv">40</span>)</span>
<span id="cb88-13"><a href="SPC.html#cb88-13"></a></span>
<span id="cb88-14"><a href="SPC.html#cb88-14"></a><span class="co"># check distance matrix:</span></span>
<span id="cb88-15"><a href="SPC.html#cb88-15"></a><span class="kw">round</span>(d, <span class="dv">1</span>)</span></code></pre></div>
<pre class="outputBlock"><code>## Dissimilarities :
##                colusa glenn kings mariposa mendocino napa san benito shasta shasta-trinity
## glenn            13.5                                                                     
## kings            16.0  12.7                                                               
## mariposa          8.4  11.3  16.5                                                         
## mendocino        11.5   8.0  16.4     15.0                                                
## napa             30.4  24.1  29.4     29.2      21.6                                      
## san benito       25.7  20.6  26.3     28.2      15.8 18.0                                 
## shasta           17.2  13.3   8.7     17.6      17.1 33.7       22.2                      
## shasta-trinity    6.4  16.6  22.3      9.6      16.5 29.8       27.2   23.3               
## tehama           28.7  22.9  27.9     27.3      20.0  8.8       15.1   31.4           27.9
## 
## Metric :  mixed ;  Types = I, I 
## Number of objects : 10</code></pre>
<div class="sourceCode" id="cb90"><pre class="sourceCode r codeBlock"><code class="sourceCode r"><span id="cb90-1"><a href="SPC.html#cb90-1"></a><span class="co"># vizualize dissimilarity matrix via divisive hierarchical clustering</span></span>
<span id="cb90-2"><a href="SPC.html#cb90-2"></a>d.diana &lt;-<span class="st"> </span><span class="kw">diana</span>(d)</span>
<span id="cb90-3"><a href="SPC.html#cb90-3"></a></span>
<span id="cb90-4"><a href="SPC.html#cb90-4"></a><span class="co"># this function is from the sharpshootR package</span></span>
<span id="cb90-5"><a href="SPC.html#cb90-5"></a><span class="co"># requires some manual adjustments</span></span>
<span id="cb90-6"><a href="SPC.html#cb90-6"></a><span class="kw">par</span>(<span class="dt">mar=</span><span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">4</span>, <span class="dv">1</span>))</span>
<span id="cb90-7"><a href="SPC.html#cb90-7"></a><span class="kw">plotProfileDendrogram</span>(sp4, d.diana, <span class="dt">scaling.factor =</span> <span class="fl">0.8</span>, <span class="dt">y.offset =</span> <span class="dv">5</span>, <span class="dt">cex.names=</span><span class="fl">0.7</span>, <span class="dt">width=</span><span class="fl">0.3</span>, <span class="dt">color=</span><span class="st">&#39;ex_Ca_to_Mg&#39;</span>)</span></code></pre></div>
<p><img src="aqpbook_files/figure-html/unnamed-chunk-41-1.png" style="display: block; margin: auto;" /></p>
<p>Try again in <code>debug</code> mode to ensure that profiles are sorted correctly.</p>
<div class="sourceCode" id="cb91"><pre class="sourceCode r codeBlock"><code class="sourceCode r"><span id="cb91-1"><a href="SPC.html#cb91-1"></a><span class="kw">plotProfileDendrogram</span>(sp4, d.diana, <span class="dt">scaling.factor =</span> <span class="fl">0.8</span>, <span class="dt">y.offset =</span> <span class="dv">5</span>, <span class="dt">cex.names=</span><span class="fl">0.7</span>, <span class="dt">width=</span><span class="fl">0.3</span>, <span class="dt">color=</span><span class="st">&#39;ex_Ca_to_Mg&#39;</span>, <span class="dt">debug =</span> <span class="ot">TRUE</span>)</span></code></pre></div>
<p><img src="aqpbook_files/figure-html/unnamed-chunk-42-1.png" style="display: block; margin: auto;" /></p>
</div>
<div id="object-metadata" class="section level2">
<h2><span class="header-section-number">2.16</span> Object Metadata</h2>
<div class="sourceCode" id="cb92"><pre class="sourceCode r codeBlock"><code class="sourceCode r"><span id="cb92-1"><a href="SPC.html#cb92-1"></a><span class="co"># print metadata:</span></span>
<span id="cb92-2"><a href="SPC.html#cb92-2"></a><span class="kw">metadata</span>(sp4)</span>
<span id="cb92-3"><a href="SPC.html#cb92-3"></a></span>
<span id="cb92-4"><a href="SPC.html#cb92-4"></a><span class="co"># alter the depth unit metadata attribute</span></span>
<span id="cb92-5"><a href="SPC.html#cb92-5"></a><span class="kw">depth_units</span>(sp4) &lt;-<span class="st"> &#39;inches&#39;</span> <span class="co"># units are really &#39;cm&#39;</span></span>
<span id="cb92-6"><a href="SPC.html#cb92-6"></a></span>
<span id="cb92-7"><a href="SPC.html#cb92-7"></a><span class="co"># more generic interface for adjusting metadata</span></span>
<span id="cb92-8"><a href="SPC.html#cb92-8"></a>md &lt;-<span class="st"> </span><span class="kw">metadata</span>(sp4) <span class="co"># save original metadata</span></span>
<span id="cb92-9"><a href="SPC.html#cb92-9"></a></span>
<span id="cb92-10"><a href="SPC.html#cb92-10"></a><span class="co"># add columns</span></span>
<span id="cb92-11"><a href="SPC.html#cb92-11"></a>md<span class="op">$</span>describer &lt;-<span class="st"> &#39;DGM&#39;</span></span>
<span id="cb92-12"><a href="SPC.html#cb92-12"></a>md<span class="op">$</span>date &lt;-<span class="st"> </span><span class="kw">as.Date</span>(<span class="st">&#39;2009-01-01&#39;</span>)</span>
<span id="cb92-13"><a href="SPC.html#cb92-13"></a>md<span class="op">$</span>citation &lt;-<span class="st"> &#39;McGahan, D.G., Southard, R.J, Claassen, V.P. 2009. Plant-Available Calcium Varies Widely in Soils on Serpentinite Landscapes. Soil Sci. Soc. Am. J. 73: 2087-2095.&#39;</span></span>
<span id="cb92-14"><a href="SPC.html#cb92-14"></a></span>
<span id="cb92-15"><a href="SPC.html#cb92-15"></a><span class="co"># re-assign user defined metadata to original object</span></span>
<span id="cb92-16"><a href="SPC.html#cb92-16"></a><span class="kw">metadata</span>(sp4) &lt;-<span class="st"> </span>md</span>
<span id="cb92-17"><a href="SPC.html#cb92-17"></a></span>
<span id="cb92-18"><a href="SPC.html#cb92-18"></a><span class="co"># check:</span></span>
<span id="cb92-19"><a href="SPC.html#cb92-19"></a><span class="kw">metadata</span>(sp4)</span>
<span id="cb92-20"><a href="SPC.html#cb92-20"></a></span>
<span id="cb92-21"><a href="SPC.html#cb92-21"></a><span class="co"># fix depth units, set back to &#39;cm&#39;</span></span>
<span id="cb92-22"><a href="SPC.html#cb92-22"></a><span class="kw">depth_units</span>(sp4) &lt;-<span class="st"> &#39;cm&#39;</span></span></code></pre></div>
</div>
<div id="validity-and-horizon-logic" class="section level2">
<h2><span class="header-section-number">2.17</span> Validity and Horizon Logic</h2>
<div class="sourceCode" id="cb93"><pre class="sourceCode r codeBlock"><code class="sourceCode r"><span id="cb93-1"><a href="SPC.html#cb93-1"></a><span class="kw">checkSPC</span>(sp4)</span>
<span id="cb93-2"><a href="SPC.html#cb93-2"></a><span class="kw">spc_in_sync</span>(sp4)</span>
<span id="cb93-3"><a href="SPC.html#cb93-3"></a>z &lt;-<span class="st"> </span><span class="kw">rebuildSPC</span>(sp4)</span>
<span id="cb93-4"><a href="SPC.html#cb93-4"></a><span class="kw">checkHzDepthLogic</span>(sp4)</span></code></pre></div>
</div>
<div id="coercion" class="section level2">
<h2><span class="header-section-number">2.18</span> Coercion</h2>
<div class="sourceCode" id="cb94"><pre class="sourceCode r codeBlock"><code class="sourceCode r"><span id="cb94-1"><a href="SPC.html#cb94-1"></a><span class="co"># check our work by viewing the internal structure</span></span>
<span id="cb94-2"><a href="SPC.html#cb94-2"></a><span class="kw">str</span>(sp4)</span>
<span id="cb94-3"><a href="SPC.html#cb94-3"></a></span>
<span id="cb94-4"><a href="SPC.html#cb94-4"></a><span class="co"># deconstruct SoilProfileCollection into a data.frame, with horizon+site data</span></span>
<span id="cb94-5"><a href="SPC.html#cb94-5"></a><span class="kw">as</span>(sp4, <span class="st">&#39;data.frame&#39;</span>)</span>
<span id="cb94-6"><a href="SPC.html#cb94-6"></a></span>
<span id="cb94-7"><a href="SPC.html#cb94-7"></a><span class="co"># deconstruct SoilProfileCollection into a list containing all slots</span></span>
<span id="cb94-8"><a href="SPC.html#cb94-8"></a><span class="kw">as</span>(sp4, <span class="st">&#39;list&#39;</span>)</span>
<span id="cb94-9"><a href="SPC.html#cb94-9"></a></span>
<span id="cb94-10"><a href="SPC.html#cb94-10"></a><span class="co"># extraction of site + spatial data as SpatialPointsDataFrame</span></span>
<span id="cb94-11"><a href="SPC.html#cb94-11"></a><span class="kw">as</span>(sp4, <span class="st">&#39;SpatialPointsDataFrame&#39;</span>)</span></code></pre></div>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="index.html" class="navigation navigation-prev navigation-unique" aria-label="Previous page"><i class="fa fa-angle-left"></i></a>

    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["aqpbook.pdf", "aqpbook.epub"],
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
